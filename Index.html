<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Task Manager Mockup</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; font-size: 14px; }
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .sidebar-link.active { background-color: #eef2ff; color: #4f46e5; font-weight: 600; }
        .submenu { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-in-out; }
        .submenu.overflow-visible { overflow: visible; }
        .status-badge { padding: 1px 6px; border-radius: 10px; font-size: 11px; font-weight: 500; }
        
        .action-menu {
            position: absolute;
            left: 0;
            top: 100%;
            margin-top: 2px;
            z-index: 50;
            background-color: white;
            border-radius: 6px;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
            border: 1px solid #e2e8f0;
            min-width: 120px;
            display: none;
        }
        .action-menu-item {
            display: block;
            width: 100%;
            padding: 6px 10px;
            font-size: 13px;
            color: #334155;
            text-align: left;
        }
        .action-menu-item:hover { background-color: #f1f5f9; }
        .action-menu-item i { margin-right: 8px; width: 14px; text-align: center; }
        
        .countdown-grid {
            display: grid;
            grid-template-columns: repeat(4, auto);
            gap: 0.6rem;
            align-items: baseline;
            justify-content: end;
            font-variant-numeric: tabular-nums;
        }
        .countdown-item {
            display: flex;
            align-items: baseline;
        }
        .countdown-number {
            font-size: 1.1rem;
            font-weight: 600;
            color: #1e293b;
        }
        .countdown-label {
            font-size: 0.7rem;
            color: #64748b;
            margin-left: 0.2rem;
        }
        .countdown .expired {
            color: #ef4444;
            font-weight: 600;
            font-size: 0.8rem;
        }

        .input-with-icon {
            position: relative;
        }
        .input-with-icon i {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #94a3b8;
        }
        .input-with-icon input, .input-with-icon select {
            padding-left: 36px;
        }
        .task-item { cursor: pointer; }
    </style>
</head>
<body class="bg-slate-100 antialiased text-slate-800">

    <div id="app-wrapper" class="flex h-screen bg-white">
        <!-- Sidebar -->
        <aside class="w-64 flex-shrink-0 bg-slate-50 border-r border-slate-200 flex flex-col">
            <div class="h-14 flex items-center px-4 border-b border-slate-200">
                <i class="fas fa-tasks text-indigo-600 text-xl"></i>
                <h1 class="text-lg font-bold ml-2 text-slate-800">TaskFlow</h1>
            </div>
            <nav id="sidebarNav" class="flex-1 px-3 py-3 space-y-1 overflow-y-auto">
                <a href="#" class="sidebar-link flex items-center px-3 py-1.5 text-slate-700 rounded-md active" data-id="home" data-title="Today's Tasks">
                    <i class="fas fa-home w-5 text-center text-sm"></i><span class="ml-2 text-sm">Home</span>
                </a>
                <a href="#" class="sidebar-link flex items-center px-3 py-1.5 text-slate-600 hover:bg-slate-200 rounded-md" data-id="upcoming" data-title="Upcoming Tasks">
                    <i class="fas fa-calendar-alt w-5 text-center text-sm"></i><span class="ml-2 text-sm">Upcoming</span>
                </a>
                <div class="pt-3">
                    <div class="flex items-center justify-between px-3">
                        <h2 class="text-xs font-semibold text-slate-400 uppercase tracking-wider">Projects</h2>
                        <button id="addProjectBtn" class="text-slate-400 hover:text-indigo-600" title="Add new project"><i class="fas fa-plus-circle text-base"></i></button>
                    </div>
                    <div id="projectList" class="mt-2 space-y-0.5"></div>
                </div>
            </nav>
            <div id="auth-container" class="p-3 border-t border-slate-200">
                <!-- This will be populated by JS -->
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 p-4 sm:p-5 lg:p-6 bg-slate-100 overflow-y-auto">
            <header class="flex items-center justify-between mb-6 gap-3">
                <div><h2 id="mainHeader" class="text-3xl font-bold text-slate-900">Today's Tasks</h2><p class="text-slate-500 text-sm mt-1" id="currentDate"></p></div>
                <div class="flex items-center gap-2">
                    <button id="addTaskBtn" class="flex items-center justify-center bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-1.5 px-3 rounded-md shadow-sm transition-transform transform hover:scale-105 text-sm"><i class="fas fa-plus mr-2 text-xs"></i>Add Task</button>
                </div>
            </header>
            
            <!-- Summary Bar -->
            <div id="summaryBar" class="mb-4">
                <!-- Populated by JS -->
            </div>

            <div id="taskList" class="space-y-3"></div>
        </main>
    </div>
    
    <!-- Modals -->
    <div id="signInModal" class="fixed inset-0 bg-gray-900 bg-opacity-60 hidden items-center justify-center z-50 p-4 backdrop-blur-sm">
        <div class="bg-white/95 rounded-xl shadow-2xl p-6 w-full max-w-sm">
            <div class="text-center mb-6">
                 <i class="fas fa-tasks text-indigo-600 text-3xl"></i>
                <h1 class="text-xl font-bold text-gray-800 mt-2">TaskFlow</h1>
            </div>
            <h2 id="authModalTitle" class="text-xl font-bold text-slate-800 mb-5 text-left">Login</h2>
            <form id="authForm" class="space-y-3">
                <div id="registerFields" class="hidden space-y-3">
                     <div>
                        <label for="authUsername" class="block text-xs font-medium text-slate-700 text-left mb-1">Username</label>
                        <input type="text" id="authUsername" class="w-full px-3 py-1.5 border border-slate-300 rounded-md text-sm" autocomplete="username">
                    </div>
                </div>
                <div>
                    <label for="authEmail" class="block text-xs font-medium text-slate-700 text-left mb-1">Email</label>
                    <input type="email" id="authEmail" class="w-full px-3 py-1.5 border border-slate-300 rounded-md text-sm" required autocomplete="email">
                </div>
                <div>
                    <label for="authPassword" class="block text-xs font-medium text-slate-700 text-left mb-1">Password</label>
                    <input type="password" id="authPassword" class="w-full px-3 py-1.5 border border-slate-300 rounded-md text-sm" required autocomplete="current-password">
                </div>
                <div id="authOptions" class="flex justify-between items-center text-xs">
                    <label class="flex items-center text-slate-600">
                        <input type="checkbox" id="authPersistence" class="h-3.5 w-3.5 rounded border-gray-300 text-indigo-600">
                        <span class="ml-2">Remember me</span>
                    </label>
                    <a href="#" id="forgotPasswordLink" class="font-semibold text-indigo-600 hover:underline">Forgot Password?</a>
                </div>
                <div id="policyField" class="hidden text-left">
                    <label class="flex items-center text-xs text-slate-600">
                        <input type="checkbox" id="authPolicy" class="h-3.5 w-3.5 rounded border-gray-300 text-indigo-600">
                        <span class="ml-2">I agree to the <a href="#" class="text-indigo-600 hover:underline">Terms & Policy</a>.</span>
                    </label>
                </div>
                <div id="authError" class="text-red-500 text-xs text-center h-3"></div>
                <button id="authSubmitBtn" type="submit" class="w-full bg-indigo-600 text-white font-bold py-2 px-4 rounded-md hover:bg-indigo-700 transition-colors text-base mt-2">
                    Sign In
                </button>
            </form>
             <div class="flex items-center my-4">
                <div class="flex-grow border-t border-gray-300"></div>
                <span class="flex-shrink mx-3 text-gray-400 text-xs">or continue with</span>
                <div class="flex-grow border-t border-gray-300"></div>
            </div>
            <div class="flex justify-center space-x-3">
                <button class="social-login-btn w-10 h-10 border border-gray-300 rounded-md flex items-center justify-center hover:bg-gray-100"><i class="fab fa-google text-lg"></i></button>
                <button class="social-login-btn w-10 h-10 border border-gray-300 rounded-md flex items-center justify-center hover:bg-gray-100"><i class="fab fa-github text-lg"></i></button>
                <button class="social-login-btn w-10 h-10 border border-gray-300 rounded-md flex items-center justify-center hover:bg-gray-100"><i class="fab fa-facebook text-lg"></i></button>
            </div>
            <p class="text-center text-xs text-slate-500 mt-5">
                <span id="authToggleText">Don't have an account?</span>
                <a href="#" id="authToggleLink" class="font-semibold text-indigo-600 hover:text-indigo-500">Register for free</a>
            </p>
        </div>
    </div>

    <div id="taskModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-3xl">
            <h3 id="taskModalTitle" class="text-xl font-bold mb-5">Add a New Task</h3>
            <form id="taskForm">
                <input type="hidden" id="taskId">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Left Column -->
                    <div class="space-y-4">
                        <div>
                            <label for="taskName" class="block text-xs font-medium text-slate-700 mb-1">Task Name</label>
                            <div class="input-with-icon">
                                <i class="fas fa-tasks"></i>
                                <input type="text" id="taskName" class="w-full px-3 py-1.5 border border-slate-300 rounded-md text-sm" required>
                            </div>
                        </div>
                        <div>
                            <label for="taskDescription" class="block text-xs font-medium text-slate-700 mb-1">Description / Instructions</label>
                            <textarea id="taskDescription" rows="5" class="w-full px-3 py-1.5 border border-slate-300 rounded-md text-sm" placeholder="Add more details about the task..."></textarea>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-slate-700 mb-1">Attachments</label>
                            <div class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-slate-300 border-dashed rounded-md">
                                <div class="space-y-1 text-center">
                                    <i class="fas fa-paperclip text-3xl text-slate-400"></i>
                                    <div class="flex text-sm text-slate-600">
                                        <label for="file-upload" class="relative cursor-pointer bg-white rounded-md font-medium text-indigo-600 hover:text-indigo-500 focus-within:outline-none">
                                            <span>Upload a file</span>
                                            <input id="file-upload" name="file-upload" type="file" class="sr-only">
                                        </label>
                                        <p class="pl-1">or drag and drop</p>
                                    </div>
                                    <p class="text-xs text-slate-500">PNG, JPG, PDF up to 10MB</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Right Column -->
                    <div class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="taskDueDate" class="block text-xs font-medium text-slate-700 mb-1">Due Date</label>
                                <input type="date" id="taskDueDate" class="w-full px-3 py-1.5 border border-slate-300 rounded-md text-sm">
                            </div>
                            <div>
                                <label for="taskDueTime" class="block text-xs font-medium text-slate-700 mb-1">Due Time</label>
                                <input type="time" id="taskDueTime" class="w-full px-3 py-1.5 border border-slate-300 rounded-md text-sm">
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label for="taskProject" class="block text-xs font-medium text-slate-700 mb-1">Project</label>
                                <select id="taskProject" class="w-full px-3 py-1.5 border border-slate-300 rounded-md text-sm"></select>
                            </div>
                            <div>
                                <label for="taskPriority" class="block text-xs font-medium text-slate-700 mb-1">Priority</label>
                                <select id="taskPriority" class="w-full px-3 py-1.5 border border-slate-300 rounded-md text-sm"><option>Low</option><option selected>Medium</option><option>High</option></select>
                            </div>
                            <div>
                                <label for="taskStatus" class="block text-xs font-medium text-slate-700 mb-1">Status</label>
                                <select id="taskStatus" class="w-full px-3 py-1.5 border border-slate-300 rounded-md text-sm"><option>To Do</option><option>In Progress</option><option>Needs Revision</option><option>Completed</option></select>
                            </div>
                        </div>
                        <div>
                            <label for="taskNotes" class="block text-xs font-medium text-slate-700 mb-1">Notes</label>
                            <textarea id="taskNotes" rows="6" class="w-full px-3 py-1.5 border border-yellow-200 bg-yellow-50 bg-opacity-70 rounded-md text-sm" placeholder="Add a quick note..."></textarea>
                        </div>
                    </div>
                </div>
                <div class="flex justify-end space-x-3 pt-5">
                    <button type="button" id="cancelTaskBtn" class="px-4 py-1.5 bg-slate-200 text-slate-800 rounded-md text-sm">Cancel</button>
                    <button type="submit" id="taskSubmitBtn" class="px-5 py-1.5 bg-indigo-600 text-white rounded-md text-sm">Add Task</button>
                </div>
            </form>
        </div>
    </div>

    <div id="taskDetailModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-2xl">
            <div class="flex justify-between items-start mb-4">
                <h3 id="detailTaskName" class="text-2xl font-bold text-slate-800"></h3>
                <button id="closeDetailBtn" class="text-slate-400 hover:text-slate-600 text-2xl">&times;</button>
            </div>
            <div class="space-y-4">
                <div>
                    <h4 class="text-sm font-semibold text-slate-500 uppercase tracking-wider">Description</h4>
                    <p id="detailTaskDescription" class="mt-1 text-slate-700 whitespace-pre-wrap"></p>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 border-t pt-4">
                    <div>
                        <h4 class="text-sm font-semibold text-slate-500 uppercase tracking-wider">Due Date</h4>
                        <p id="detailTaskDueDate" class="mt-1 text-slate-700"></p>
                    </div>
                    <div>
                        <h4 class="text-sm font-semibold text-slate-500 uppercase tracking-wider">Project</h4>
                        <p id="detailTaskProject" class="mt-1 text-slate-700"></p>
                    </div>
                    <div>
                        <h4 class="text-sm font-semibold text-slate-500 uppercase tracking-wider">Status</h4>
                        <p id="detailTaskStatus" class="mt-1 text-slate-700"></p>
                    </div>
                </div>
                 <div>
                    <h4 class="text-sm font-semibold text-slate-500 uppercase tracking-wider">Notes</h4>
                    <div id="detailTaskNotes" class="mt-1 p-3 bg-yellow-50 border border-yellow-200 rounded-md text-slate-700 whitespace-pre-wrap"></div>
                </div>
            </div>
            <div class="flex justify-end space-x-3 pt-5 mt-4 border-t">
                <button type="button" id="editDetailBtn" class="px-5 py-1.5 bg-indigo-600 text-white rounded-md text-sm">Edit Task</button>
            </div>
        </div>
    </div>

    <div id="archiveConfirmModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm text-center">
            <i class="fas fa-archive text-3xl text-amber-500 mb-4"></i>
            <h3 class="text-lg font-bold mb-2">Archive Completed Tasks?</h3>
            <p class="text-sm text-slate-600 mb-6">This will permanently remove all completed tasks. This action cannot be undone.</p>
            <div class="flex justify-center space-x-4">
                <button id="cancelArchiveBtn" class="px-6 py-2 bg-slate-200 text-slate-800 rounded-lg">Cancel</button>
                <button id="confirmArchiveBtn" class="px-6 py-2 bg-red-600 text-white rounded-lg">Archive</button>
            </div>
        </div>
    </div>

    <div id="projectModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm">
            <h3 id="projectModalTitle" class="text-xl font-bold mb-5">Add a New Project</h3>
            <form id="projectForm"><input type="hidden" id="projectId"><div class="mb-5"><label for="projectName" class="block text-xs font-medium text-slate-700 mb-1">Project Name</label><input type="text" id="projectName" class="w-full px-3 py-1.5 border border-slate-300 rounded-md text-sm" required></div><div class="flex justify-end space-x-3"><button type="button" id="cancelProjectBtn" class="px-4 py-1.5 bg-slate-200 text-slate-800 rounded-md text-sm">Cancel</button><button type="submit" id="projectSubmitBtn" class="px-4 py-1.5 bg-indigo-600 text-white rounded-md text-sm">Create</button></div></form>
        </div>
    </div>
    
    <div id="subProjectModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm">
            <h3 id="subProjectModalTitle" class="text-xl font-bold mb-5">Add New Item</h3>
            <form id="subProjectForm"><input type="hidden" id="subProjectId"><input type="hidden" id="parentProjectId"><div class="mb-5"><label for="subProjectName" class="block text-xs font-medium text-slate-700 mb-1">Item Name</label><input type="text" id="subProjectName" class="w-full px-3 py-1.5 border border-slate-300 rounded-md text-sm" required></div><div class="flex justify-end space-x-3"><button type="button" id="cancelSubProjectBtn" class="px-4 py-1.5 bg-slate-200 text-slate-800 rounded-md text-sm">Cancel</button><button type="submit" id="subProjectSubmitBtn" class="px-4 py-1.5 bg-indigo-600 text-white rounded-md text-sm">Create</button></div></form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, setPersistence, browserLocalPersistence, browserSessionPersistence, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, addDoc, updateDoc, deleteDoc, onSnapshot, collection, query, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ===================================================================================
        // ============================ FIREBASE CONFIGURATION ===============================
        // ===================================================================================
        //
        //  YOUR FIREBASE CONFIGURATION OBJECT
        //
        const firebaseConfig = {
          apiKey: "AIzaSyBXx77dhZQAmVocuulRX_G6h7mycSiYprY",
          authDomain: "gowafir-taskflow.firebaseapp.com",
          projectId: "gowafir-taskflow",
          storageBucket: "gowafir-taskflow.appspot.com",
          messagingSenderId: "970559027923",
          appId: "1:970559027923:web:0a37d1fbb446623064f226",
          measurementId: "G-KZFBXZLYC4"
        };
        //
        // ===================================================================================
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // --- LOCAL STATE ---
        let localState = {
            projects: [],
            tasks: [],
            activeView: { type: 'home', id: 'home', title: "Today's Tasks" },
            editing: { type: null, id: null },
            userId: null,
            projectsUnsubscribe: null,
            tasksUnsubscribe: null,
            isRegisterMode: false,
        };

        // --- DOM ELEMENTS ---
        const mainHeader = document.getElementById('mainHeader');
        const taskListEl = document.getElementById('taskList');
        const projectListEl = document.getElementById('projectList');
        const sidebarNav = document.getElementById('sidebarNav');
        const taskModal = document.getElementById('taskModal');
        const projectModal = document.getElementById('projectModal');
        const subProjectModal = document.getElementById('subProjectModal');
        const signInModal = document.getElementById('signInModal');
        const authContainer = document.getElementById('auth-container');
        const appWrapper = document.getElementById('app-wrapper');
        const authForm = document.getElementById('authForm');
        const taskFormEl = document.getElementById('taskForm');
        const taskDetailModal = document.getElementById('taskDetailModal');
        const archiveConfirmModal = document.getElementById('archiveConfirmModal');

        // --- RENDER FUNCTIONS ---
        function renderAll() {
            renderProjects();
            renderTasks();
            updateProjectDropdown();
        }

        function renderProjects() {
            projectListEl.innerHTML = '';
            localState.projects.forEach(p => {
                const projectEl = document.createElement('div');
                projectEl.className = 'project-item';
                projectEl.dataset.id = p.id;
                projectEl.innerHTML = `
                    <div class="flex items-center justify-between w-full rounded-md hover:bg-slate-200">
                        <div class="relative">
                            <button class="action-menu-btn text-slate-400 hover:text-slate-600 p-1.5 rounded-md"><i class="fas fa-ellipsis-v text-xs"></i></button>
                            <div class="action-menu">
                                <button class="action-menu-item edit-btn"><i class="fas fa-pencil-alt"></i>Edit</button>
                                <button class="action-menu-item delete-btn"><i class="fas fa-trash-alt"></i>Delete</button>
                            </div>
                        </div>
                        <a href="#" class="sidebar-link flex-1 flex items-center px-1.5 py-1.5 text-slate-600 rounded-md" data-id="${p.id}" data-title="${p.name}">
                            <div class="flex items-center"><span class="w-1.5 h-1.5 bg-purple-500 rounded-full"></span><span class="ml-2 project-name text-sm">${p.name}</span></div>
                        </a>
                        <i class="fas fa-chevron-down text-xs transition-transform p-1.5 cursor-pointer expand-btn"></i>
                    </div>
                    <div class="submenu ml-5 space-y-0.5 py-1">
                        ${(p.subProjects || []).map(sp => `
                            <div class="sub-project-item flex items-center justify-between w-full rounded-md hover:bg-slate-200" data-id="${sp.id}" data-parent-id="${p.id}">
                                <div class="relative">
                                    <button class="action-menu-btn text-slate-400 hover:text-slate-600 p-1.5 rounded-md"><i class="fas fa-ellipsis-v text-xxs"></i></button>
                                    <div class="action-menu">
                                        <button class="action-menu-item edit-btn"><i class="fas fa-pencil-alt"></i>Edit</button>
                                        <button class="action-menu-item delete-btn"><i class="fas fa-trash-alt"></i>Delete</button>
                                    </div>
                                </div>
                                <a href="#" class="sidebar-link flex-1 block px-2 py-1 text-xs text-slate-500 rounded-md" data-id="${sp.id}" data-title="${sp.name}">${sp.name}</a>
                            </div>
                        `).join('')}
                        <button class="add-sub-project-btn flex items-center w-full text-left px-2 py-1 text-xs text-slate-400 hover:text-indigo-600 rounded-md"><i class="fas fa-plus mr-1.5 text-xxs"></i>Add item</button>
                    </div>`;
                projectListEl.appendChild(projectEl);
            });
        }
        
        function renderTasks() {
            taskListEl.innerHTML = '';
            let tasksToRender = [];
            // 1. Filter by active view
            if (localState.activeView.type === 'home' || localState.activeView.type === 'upcoming') {
                tasksToRender = localState.tasks;
            } else if (localState.activeView.type === 'project') {
                const proj = localState.projects.find(p => p.id === localState.activeView.id);
                if(proj) {
                    const subProjectIds = (proj.subProjects || []).map(sp => sp.id);
                    tasksToRender = localState.tasks.filter(t => t.projectId === proj.id || subProjectIds.includes(t.projectId));
                }
            } else if (localState.activeView.type === 'sub-project') {
                tasksToRender = localState.tasks.filter(t => t.projectId === localState.activeView.id);
            }
            
            if (tasksToRender.length === 0) {
                taskListEl.innerHTML = `<p class="text-slate-500 text-center py-6 text-sm">No tasks in this view.</p>`;
                return;
            }

            tasksToRender.forEach(t => {
                const priorityColors = { High: 'text-red-500', Medium: 'text-orange-500', Low: 'text-green-500' };
                const statusColors = { 'To Do': 'bg-slate-200 text-slate-600', 'In Progress': 'bg-blue-100 text-blue-600', 'Needs Revision': 'bg-amber-100 text-amber-600', 'Completed': 'bg-green-100 text-green-600' };
                
                let mainProjectName = '';
                for (const p of localState.projects) {
                    if (p.id === t.projectId) {
                        mainProjectName = p.name;
                        break;
                    }
                    const sp = (p.subProjects || []).find(sp => sp.id === t.projectId);
                    if (sp) {
                        mainProjectName = p.name;
                        break;
                    }
                }

                const taskEl = document.createElement('div');
                taskEl.className = 'task-item bg-white p-3 rounded-lg shadow-sm border border-slate-200 flex items-center justify-between transition gap-4';
                taskEl.dataset.id = t.id;
                taskEl.innerHTML = `
                    <div class="relative flex-shrink-0">
                         <button class="action-menu-btn text-slate-400 hover:text-slate-600 p-1.5 rounded-md"><i class="fas fa-ellipsis-v text-xs"></i></button>
                         <div class="action-menu">
                             <button class="action-menu-item edit-btn"><i class="fas fa-pencil-alt"></i>Edit</button>
                             <button class="action-menu-item delete-btn"><i class="fas fa-trash-alt"></i>Delete</button>
                         </div>
                    </div>
                    <div class="flex-1 flex items-baseline gap-2 truncate">
                        <p class="font-semibold text-slate-800 task-name text-base truncate" title="${t.name}">${t.name}</p>
                        ${mainProjectName ? `<p class="text-xs text-slate-400 font-medium truncate" title="Project: ${mainProjectName}">[${mainProjectName}]</p>` : ''}
                    </div>
                    <div class="flex items-center gap-4 flex-shrink-0">
                        <div class="flex items-center text-xs text-slate-500">
                            <i class="fas fa-flag ${priorityColors[t.priority]} mr-1.5"></i><span class="mr-3">${t.priority}</span>
                            <span class="status-badge ${statusColors[t.status]}">${t.status}</span>
                        </div>
                        <div class="countdown" data-due-date="${t.dueDate}" data-due-time="${t.dueTime || ''}"></div>
                    </div>`;
                taskListEl.appendChild(taskEl);
            });
            updateCountdowns();
        }

        function renderSummaryBar() {
            const summaryBarEl = document.getElementById('summaryBar');
            if (!summaryBarEl) return;

            const totalTasks = localState.tasks.filter(t => t.status !== 'Completed').length;
            const revisionTasks = localState.tasks.filter(t => t.status === 'Needs Revision').length;
            const completedTasks = localState.tasks.filter(t => t.status === 'Completed').length;

            summaryBarEl.innerHTML = `
                <div class="flex items-center justify-between bg-white p-3 rounded-lg shadow-sm text-sm">
                    <div class="flex items-center gap-6">
                        <div class="flex items-center gap-2">
                            <span class="text-slate-600">Active Tasks:</span>
                            <span class="bg-indigo-100 text-indigo-700 font-bold px-2 py-0.5 rounded-full text-xs">${totalTasks}</span>
                        </div>
                        <div class="flex items-center gap-2 text-slate-500">
                            <span>For Revision:</span>
                            <span class="font-semibold">${revisionTasks}</span>
                        </div>
                        <div class="flex items-center gap-2 text-slate-500">
                            <span>Completed:</span>
                            <span class="font-semibold">${completedTasks}</span>
                        </div>
                    </div>
                    <div>
                        ${completedTasks > 0 ? `<button id="archiveBtn" class="text-xs text-indigo-600 hover:underline font-semibold" title="Archive all completed tasks"><i class="fas fa-archive mr-1"></i>Archive</button>` : ''}
                    </div>
                </div>
            `;

            if (completedTasks > 0) {
                document.getElementById('archiveBtn')?.addEventListener('click', () => {
                    archiveConfirmModal.style.display = 'flex';
                });
            }
        }

        function updateProjectDropdown() {
            const select = document.getElementById('taskProject');
            select.innerHTML = '<option value="">Select Project</option>';
            localState.projects.forEach(p => {
                const mainOption = document.createElement('option');
                mainOption.value = p.id;
                mainOption.textContent = p.name;
                mainOption.style.fontWeight = 'bold';
                select.appendChild(mainOption);

                (p.subProjects || []).forEach(sp => {
                    const subOption = document.createElement('option');
                    subOption.value = sp.id;
                    subOption.textContent = `\u00A0\u00A0\u00A0↳ ${sp.name}`;
                    select.appendChild(subOption);
                });
            });
        }

        function updateCountdowns() {
            document.querySelectorAll('.countdown').forEach(el => {
                const dueDate = el.dataset.dueDate;
                const dueTime = el.dataset.dueTime;
                
                if (!dueDate) {
                    el.innerHTML = ''; return;
                }
                
                const dueDateTimeString = `${dueDate}${dueTime ? 'T' + dueTime : 'T23:59:59'}`;
                const distance = new Date(dueDateTimeString).getTime() - new Date().getTime();

                if (distance < 0) {
                    el.innerHTML = `<span class="expired">Expired</span>`; return;
                }

                const d = Math.floor(distance / (1000 * 60 * 60 * 24));
                const h = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const m = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                const s = Math.floor((distance % (1000 * 60)) / 1000);
                
                el.innerHTML = `<div class="countdown-grid">
                        <div class="countdown-item"><span class="countdown-number">${String(d).padStart(2, '0')}</span><span class="countdown-label">d</span></div>
                        <div class="countdown-item"><span class="countdown-number">${String(h).padStart(2, '0')}</span><span class="countdown-label">h</span></div>
                        <div class="countdown-item"><span class="countdown-number">${String(m).padStart(2, '0')}</span><span class="countdown-label">m</span></div>
                        <div class="countdown-item"><span class="countdown-number">${String(s).padStart(2, '0')}</span><span class="countdown-label">s</span></div>
                    </div>`;
            });
        }

        async function renderAuthUI(user) {
            if (user && !user.isAnonymous) {
                const profilePath = `/users/${user.uid}`;
                const profileDoc = await getDoc(doc(db, profilePath));
                const profileData = profileDoc.exists() ? profileDoc.data() : { username: user.email };

                authContainer.innerHTML = `
                    <div class="flex items-center">
                        <img class="h-8 w-8 rounded-full object-cover" src="https://placehold.co/100x100/E2E8F0/475569?text=${profileData.username.charAt(0).toUpperCase()}" alt="User avatar">
                        <div class="ml-2 overflow-hidden">
                            <p class="text-sm font-semibold text-slate-700 truncate">${profileData.username}</p>
                            <a href="#" class="text-xs text-slate-500 hover:text-indigo-600" id="signOutBtn">Sign Out</a>
                        </div>
                    </div>`;
                document.getElementById('signOutBtn').addEventListener('click', () => signOut(auth));
                signInModal.style.display = 'none';
                appWrapper.classList.remove('blur-sm', 'pointer-events-none');
            } else {
                authContainer.innerHTML = `<button id="showSignInBtn" class="w-full bg-indigo-600 text-white font-bold py-1.5 px-3 rounded-md hover:bg-indigo-700 text-sm">Sign In / Register</button>`;
                document.getElementById('showSignInBtn').addEventListener('click', () => {
                    signInModal.style.display = 'flex';
                });
                appWrapper.classList.add('blur-sm', 'pointer-events-none');
                signInModal.style.display = 'flex';
            }
        }

        // --- EVENT HANDLERS ---
        document.body.addEventListener('click', e => {
            if (!e.target.closest('.action-menu-btn')) {
                document.querySelectorAll('.action-menu').forEach(menu => menu.style.display = 'none');
                document.querySelectorAll('.submenu').forEach(sm => sm.classList.remove('overflow-visible'));
            }
        });

        sidebarNav.addEventListener('click', e => {
            const link = e.target.closest('.sidebar-link');
            if (link) {
                e.preventDefault();
                document.querySelectorAll('.sidebar-link').forEach(l => l.classList.remove('active'));
                link.classList.add('active');
                const id = link.dataset.id, title = link.dataset.title, parent = link.closest('.sub-project-item');
                if (id === 'home' || id === 'upcoming') localState.activeView = { type: 'home', id, title };
                else if (parent) localState.activeView = { type: 'sub-project', id, title };
                else localState.activeView = { type: 'project', id, title };
                mainHeader.textContent = title;
                renderTasks();
            }
        });

        projectListEl.addEventListener('click', async e => {
            const target = e.target;
            const projectItem = target.closest('.project-item');
            const subProjectItem = target.closest('.sub-project-item');

            if (target.closest('.action-menu-btn')) {
                e.stopPropagation();
                const menu = target.closest('.relative').querySelector('.action-menu');
                const isVisible = menu.style.display === 'block';
                document.querySelectorAll('.action-menu').forEach(m => m.style.display = 'none');
                document.querySelectorAll('.submenu').forEach(sm => sm.classList.remove('overflow-visible'));
                if (!isVisible) {
                    menu.style.display = 'block';
                    const parentSubmenu = target.closest('.submenu');
                    if (parentSubmenu) parentSubmenu.classList.add('overflow-visible');
                }
            } else if (target.closest('.expand-btn')) {
                const submenu = projectItem.querySelector('.submenu');
                submenu.style.maxHeight = submenu.style.maxHeight ? null : submenu.scrollHeight + "px";
                target.closest('.expand-btn').classList.toggle('rotate-180');
            } else if (target.closest('.edit-btn')) {
                if (subProjectItem) openSubProjectModal('edit', subProjectItem);
                else if (projectItem) openProjectModal('edit', projectItem);
            } else if (target.closest('.delete-btn')) {
                if (subProjectItem) {
                    const parentId = subProjectItem.dataset.parentId;
                    const subId = subProjectItem.dataset.id;
                    const parentDoc = localState.projects.find(p => p.id === parentId);
                    const updatedSubProjects = parentDoc.subProjects.filter(sp => sp.id !== subId);
                    await updateDoc(doc(localState.projectsCollectionRef, parentId), { subProjects: updatedSubProjects });
                } else if (projectItem) {
                    await deleteDoc(doc(localState.projectsCollectionRef, projectItem.dataset.id));
                }
            } else if (target.closest('.add-sub-project-btn')) {
                openSubProjectModal('add', projectItem);
            }
        });

        taskListEl.addEventListener('click', async e => {
            const taskItem = e.target.closest('.task-item');
            if (!taskItem) return;

            if (e.target.closest('.action-menu-btn')) {
                e.stopPropagation();
                const menu = e.target.closest('.relative').querySelector('.action-menu');
                const isVisible = menu.style.display === 'block';
                document.querySelectorAll('.action-menu').forEach(m => m.style.display = 'none');
                menu.style.display = isVisible ? 'none' : 'block';
            } else if (e.target.closest('.edit-btn')) {
                 const task = localState.tasks.find(t => t.id === taskItem.dataset.id);
                 if(task) openTaskModal('edit', taskItem);
            } else if (e.target.closest('.delete-btn')) {
                await deleteDoc(doc(localState.tasksCollectionRef, taskItem.dataset.id));
            } else {
                const taskId = taskItem.dataset.id;
                const task = localState.tasks.find(t => t.id === taskId);
                if (task) {
                    openTaskDetailModal(task);
                }
            }
        });

        document.getElementById('addProjectBtn').addEventListener('click', () => openProjectModal('add'));
        document.getElementById('addTaskBtn').addEventListener('click', () => openTaskModal('add'));
        
        // --- MODAL & FORM LOGIC ---
        function openProjectModal(mode, el = null) {
            projectForm.reset();
            if (mode === 'edit') {
                const project = localState.projects.find(p => p.id === el.dataset.id);
                localState.editing = { type: 'project', id: project.id };
                document.getElementById('projectModalTitle').textContent = 'Edit Project';
                document.getElementById('projectName').value = project.name;
                document.getElementById('projectSubmitBtn').textContent = 'Save Changes';
            } else {
                localState.editing = { type: 'project', id: null };
                document.getElementById('projectModalTitle').textContent = 'Add a New Project';
                document.getElementById('projectSubmitBtn').textContent = 'Create';
            }
            projectModal.style.display = 'flex';
        }

        function openSubProjectModal(mode, parentEl) {
            subProjectForm.reset();
            if (mode === 'edit') {
                const parentId = parentEl.dataset.parentId;
                const subProjectId = parentEl.dataset.id;
                const subProject = localState.projects.find(p => p.id === parentId).subProjects.find(sp => sp.id === subProjectId);
                localState.editing = { type: 'sub-project', id: subProjectId, parentId: parentId };
                document.getElementById('subProjectModalTitle').textContent = 'Edit Item';
                document.getElementById('subProjectName').value = subProject.name;
                document.getElementById('subProjectSubmitBtn').textContent = 'Save Changes';
            } else {
                localState.editing = { type: 'sub-project', id: null, parentId: parentEl.dataset.id };
                document.getElementById('subProjectModalTitle').textContent = 'Add New Item';
                document.getElementById('subProjectSubmitBtn').textContent = 'Create';
            }
            subProjectModal.style.display = 'flex';
        }

        function openTaskModal(mode, el = null) {
            taskFormEl.reset();
            document.getElementById('taskName').classList.remove('border-red-500');
            document.getElementById('taskProject').classList.remove('border-red-500');
            updateProjectDropdown();
            if (mode === 'edit') {
                const task = localState.tasks.find(t => t.id === el.dataset.id);
                localState.editing = { type: 'task', id: task.id };
                document.getElementById('taskModalTitle').textContent = 'Edit Task';
                document.getElementById('taskName').value = task.name;
                document.getElementById('taskDescription').value = task.description || '';
                document.getElementById('taskDueDate').value = task.dueDate;
                document.getElementById('taskDueTime').value = task.dueTime || '';
                document.getElementById('taskProject').value = task.projectId;
                document.getElementById('taskPriority').value = task.priority;
                document.getElementById('taskStatus').value = task.status;
                document.getElementById('taskNotes').value = task.notes || '';
                document.getElementById('taskSubmitBtn').textContent = 'Save Changes';
            } else {
                localState.editing = { type: 'task', id: null };
                document.getElementById('taskModalTitle').textContent = 'Add a New Task';
                document.getElementById('taskSubmitBtn').textContent = 'Add Task';
                if (localState.activeView.type === 'sub-project') {
                    document.getElementById('taskProject').value = localState.activeView.id;
                } else if (localState.activeView.type === 'project') {
                    document.getElementById('taskProject').value = localState.activeView.id;
                }
            }
            taskModal.style.display = 'flex';
        }

        function openTaskDetailModal(task) {
            document.getElementById('detailTaskName').textContent = task.name || 'No Title';
            document.getElementById('detailTaskDescription').textContent = task.description || 'No description provided.';
            
            let dueDateText = 'Not set';
            if (task.dueDate) {
                dueDateText = new Date(task.dueDate + 'T00:00:00').toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
                if (task.dueTime) {
                    dueDateText += ' at ' + new Date('1970-01-01T' + task.dueTime).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
                }
            }
            document.getElementById('detailTaskDueDate').textContent = dueDateText;

            let projectName = 'N/A';
            const mainProject = localState.projects.find(p => p.id === task.projectId);

            if (mainProject) {
                projectName = mainProject.name;
            } else {
                 for (const p of localState.projects) {
                    const sp = (p.subProjects || []).find(sp => sp.id === task.projectId);
                    if (sp) {
                        projectName = `${p.name} / ${sp.name}`;
                        break;
                    }
                }
            }
           
            document.getElementById('detailTaskProject').textContent = projectName;
            document.getElementById('detailTaskStatus').textContent = task.status || 'N/A';
            document.getElementById('detailTaskNotes').textContent = task.notes || 'No notes added.';
            taskDetailModal.dataset.editingId = task.id;
            taskDetailModal.style.display = 'flex';
        }
        
        projectForm.addEventListener('submit', async e => {
            e.preventDefault();
            const name = document.getElementById('projectName').value.trim();
            if (!name) return;
            if (localState.editing.id) {
                const projectRef = doc(localState.projectsCollectionRef, localState.editing.id);
                await updateDoc(projectRef, { name });
            } else {
                await addDoc(localState.projectsCollectionRef, { name, subProjects: [] });
            }
            projectModal.style.display = 'none';
        });

        subProjectForm.addEventListener('submit', async e => {
            e.preventDefault();
            const name = document.getElementById('subProjectName').value.trim();
            if (!name) return;
            const parentProjectRef = doc(localState.projectsCollectionRef, localState.editing.parentId);
            const parentProject = localState.projects.find(p => p.id === localState.editing.parentId);
            let updatedSubProjects;
            if (localState.editing.id) {
                updatedSubProjects = parentProject.subProjects.map(sp => sp.id === localState.editing.id ? { ...sp, name } : sp);
            } else {
                updatedSubProjects = [...(parentProject.subProjects || []), { id: `sub-${Date.now()}`, name }];
            }
            await updateDoc(parentProjectRef, { subProjects: updatedSubProjects });
            subProjectModal.style.display = 'none';
        });

        taskFormEl.addEventListener('submit', async e => {
            e.preventDefault();
            const taskNameInput = document.getElementById('taskName');
            const taskProjectSelect = document.getElementById('taskProject');
            
            taskNameInput.classList.remove('border-red-500');
            taskProjectSelect.classList.remove('border-red-500');

            const formData = {
                name: taskNameInput.value.trim(),
                description: document.getElementById('taskDescription').value.trim(),
                dueDate: document.getElementById('taskDueDate').value,
                dueTime: document.getElementById('taskDueTime').value,
                projectId: taskProjectSelect.value,
                priority: document.getElementById('taskPriority').value,
                status: document.getElementById('taskStatus').value,
                notes: document.getElementById('taskNotes').value.trim(),
            };

            let formIsValid = true;
            if (!formData.name) {
                taskNameInput.classList.add('border-red-500', 'focus:border-red-500', 'focus:ring-red-500');
                formIsValid = false;
            }
            if (!formData.projectId) {
                taskProjectSelect.classList.add('border-red-500', 'focus:border-red-500', 'focus:ring-red-500');
                formIsValid = false;
            }

            if (!formIsValid) {
                return;
            }

            if (localState.editing.id) {
                const taskRef = doc(localState.tasksCollectionRef, localState.editing.id);
                await updateDoc(taskRef, formData);
            } else {
                await addDoc(localState.tasksCollectionRef, formData);
            }
            taskModal.style.display = 'none';
        });

        async function archiveCompletedTasks() {
            const batch = writeBatch(db);
            const completedTasks = localState.tasks.filter(t => t.status === 'Completed');

            completedTasks.forEach(task => {
                const taskRef = doc(localState.tasksCollectionRef, task.id);
                batch.delete(taskRef);
            });

            try {
                await batch.commit();
                console.log("Archived all completed tasks.");
            } catch (error) {
                console.error("Error archiving tasks: ", error);
            }
            archiveConfirmModal.style.display = 'none';
        }

        document.getElementById('cancelProjectBtn').addEventListener('click', () => projectModal.style.display = 'none');
        document.getElementById('cancelSubProjectBtn').addEventListener('click', () => subProjectModal.style.display = 'none');
        document.getElementById('cancelTaskBtn').addEventListener('click', () => taskModal.style.display = 'none');
        document.getElementById('closeDetailBtn').addEventListener('click', () => taskDetailModal.style.display = 'none');
        document.getElementById('editDetailBtn').addEventListener('click', () => {
            const taskId = taskDetailModal.dataset.editingId;
            const taskItemEl = taskListEl.querySelector(`.task-item[data-id="${taskId}"]`);
            if (taskItemEl) {
                taskDetailModal.style.display = 'none';
                openTaskModal('edit', taskItemEl);
            }
        });
        document.getElementById('cancelArchiveBtn').addEventListener('click', () => archiveConfirmModal.style.display = 'none');
        document.getElementById('confirmArchiveBtn').addEventListener('click', archiveCompletedTasks);
        
        // --- AUTH & FIRESTORE LISTENERS ---
        function setupFirestoreListeners(userId) {
            localState.userId = userId;
            console.log("Setting up listeners for user:", userId);
            
            const projectsCollectionRef = collection(db, 'users', userId, 'projects');
            const tasksCollectionRef = collection(db, 'users', userId, 'tasks');
            localState.projectsCollectionRef = projectsCollectionRef;
            localState.tasksCollectionRef = tasksCollectionRef;

            // Seed initial data if the user has none
            getDocs(projectsCollectionRef).then(initialCheck => {
                if (initialCheck.empty) {
                    console.log("No projects found for this user. Seeding initial data.");
                    const batch = writeBatch(db);
                    const initialProjects = [
                        { id: 'proj-1', name: 'Personal', subProjects: [{id: 'sub-1', name: 'Groceries'}, {id: 'sub-2', name: 'Fitness Plan'}] },
                        { id: 'proj-2', name: 'My Company', subProjects: [{id: 'sub-3', name: 'Q3 Report'}, {id: 'sub-4', name: 'Website Launch'}] }
                    ];
                    initialProjects.forEach(p => {
                        const docRef = doc(projectsCollectionRef, p.id);
                        batch.set(docRef, p);
                    });
                    batch.commit();
                }
            }).catch(error => {
                console.error("Error checking for initial documents:", error);
            });

            localState.projectsUnsubscribe = onSnapshot(projectsCollectionRef, (snapshot) => {
                localState.projects = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderAll();
            }, (error) => {
                console.error("Error in projects snapshot listener:", error);
            });

            localState.tasksUnsubscribe = onSnapshot(tasksCollectionRef, (snapshot) => {
                localState.tasks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderTasks();
                renderSummaryBar();
            }, (error) => {
                console.error("Error in tasks snapshot listener:", error);
            });
        }

        function cleanupFirestoreListeners() {
            if (localState.projectsUnsubscribe) localState.projectsUnsubscribe();
            if (localState.tasksUnsubscribe) localState.tasksUnsubscribe();
            localState.projects = [];
            localState.tasks = [];
            renderAll();
            renderSummaryBar();
        }

        // Auth Form Toggle
        const authToggleLink = document.getElementById('authToggleLink');
        authToggleLink.addEventListener('click', (e) => {
            e.preventDefault();
            localState.isRegisterMode = !localState.isRegisterMode;
            const title = document.getElementById('authModalTitle');
            const submitBtn = document.getElementById('authSubmitBtn');
            const toggleText = document.getElementById('authToggleText');
            const registerFields = document.getElementById('registerFields');
            const policyField = document.getElementById('policyField');
            const authOptions = document.getElementById('authOptions');
            document.getElementById('authError').textContent = '';

            if (localState.isRegisterMode) {
                title.textContent = 'Create an Account';
                submitBtn.textContent = 'Register';
                toggleText.textContent = 'Already have an account?';
                authToggleLink.textContent = 'Sign In';
                registerFields.classList.remove('hidden');
                policyField.classList.remove('hidden');
                authOptions.classList.add('hidden');
            } else {
                title.textContent = 'Welcome Back';
                submitBtn.textContent = 'Sign In';
                toggleText.textContent = "Don't have an account?";
                authToggleLink.textContent = 'Register';
                registerFields.classList.add('hidden');
                policyField.classList.add('hidden');
                authOptions.classList.remove('hidden');
            }
        });

        // Auth Form Submission
        authForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('authEmail').value;
            const password = document.getElementById('authPassword').value;
            const errorDiv = document.getElementById('authError');
            const keepLoggedIn = document.getElementById('authPersistence').checked;
            errorDiv.textContent = '';

            const persistence = keepLoggedIn ? browserLocalPersistence : browserSessionPersistence;

            try {
                await setPersistence(auth, persistence);

                if (localState.isRegisterMode) {
                    const username = document.getElementById('authUsername').value;
                    const policyChecked = document.getElementById('authPolicy').checked;

                    if (!username) {
                        errorDiv.textContent = 'Username is required.';
                        return;
                    }
                    if (!policyChecked) {
                        errorDiv.textContent = 'You must agree to the terms and policy.';
                        return;
                    }

                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    const user = userCredential.user;
                    const profilePath = `/users/${user.uid}`;
                    await setDoc(doc(db, profilePath), {
                        username,
                        email
                    });

                } else {
                    await signInWithEmailAndPassword(auth, email, password);
                }
                // onAuthStateChanged will handle the rest
            } catch (error) {
                errorDiv.textContent = error.message;
            }
        });
        
        document.getElementById('forgotPasswordLink').addEventListener('click', (e) => {
            e.preventDefault();
            const email = prompt("Please enter your email address to reset your password:");
            if (email) {
                sendPasswordResetEmail(auth, email)
                    .then(() => {
                        alert("Password reset email sent! Please check your inbox.");
                    })
                    .catch((error) => {
                        document.getElementById('authError').textContent = error.message;
                    });
            }
        });

        document.querySelectorAll('.social-login-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                alert("Social login is coming soon!");
            });
        });

        // --- INITIALIZATION ---
        document.getElementById('currentDate').textContent = new Date().toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });
        setInterval(updateCountdowns, 1000);
        
        onAuthStateChanged(auth, async (user) => {
            renderAuthUI(user);
            if (user && !user.isAnonymous) {
                setupFirestoreListeners(user.uid);
            } else {
                cleanupFirestoreListeners();
            }
        });

    </script>
</body>
</html>
