<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TaskFlow</title>
    <script>
        // Set theme on initial load to prevent FOUC (Flash of Unstyled Content)
        if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark')
        } else {
            document.documentElement.classList.remove('dark')
        }
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Configure Tailwind CSS to use the 'class' strategy for dark mode
        tailwind.config = {
          darkMode: 'class',
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; font-size: 14px; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        html.dark ::-webkit-scrollbar-track { background: #1e293b; }
        html.dark ::-webkit-scrollbar-thumb { background: #475569; }
        html.dark ::-webkit-scrollbar-thumb:hover { background: #64748b; }

        .sidebar-link.active { background-color: #eef2ff; color: #4f46e5; font-weight: 600; }
        html.dark .sidebar-link.active { background-color: #3730a3; color: #e0e7ff; }
        
        .submenu { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-in-out; }
        .submenu.overflow-visible { overflow: visible; }
        
        .action-menu {
            position: absolute;
            left: 0;
            top: 100%;
            margin-top: 2px;
            z-index: 50;
            display: none;
        }
        
        .countdown-grid {
            display: grid;
            grid-template-columns: repeat(4, auto);
            gap: 0.6rem;
            align-items: baseline;
            justify-content: end;
            font-variant-numeric: tabular-nums;
        }
        .countdown-item { display: flex; align-items: baseline; }
        .countdown-number { font-size: 1.1rem; font-weight: 600; }
        .countdown-label { font-size: 0.7rem; margin-left: 0.2rem; }
        .countdown .late { font-weight: 600; font-size: 1rem; }

        .input-with-icon { position: relative; }
        .input-with-icon i {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
        }
        .input-with-icon input, .input-with-icon select { padding-left: 36px; }
        .subtask-item input:checked + span { text-decoration: line-through; }
        #loading-overlay {
            position: fixed;
            inset: 0;
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: opacity 0.3s ease-in-out;
        }
        
        #ai-assistant-bar {
            background: linear-gradient(90deg, #6366f1, #a855f7, #ec4899, #6366f1);
            background-size: 200% auto;
            transition: all 0.3s ease-in-out;
            animation: gradient-animation 6s linear infinite;
        }
        @keyframes gradient-animation {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        #toast-notification {
            position: fixed;
            bottom: -100px;
            left: 50%;
            transform: translateX(-50%);
            transition: bottom 0.5s ease-in-out;
            z-index: 10000;
        }
        #toast-notification.show {
            bottom: 20px;
        }
        
        /* AI Hub Modal Styles */
        .ai-tool-nav-btn.active {
            background-color: #eef2ff;
            color: #4f46e5;
            font-weight: 600;
        }
        html.dark .ai-tool-nav-btn.active {
            background-color: #3730a3;
            color: #e0e7ff;
        }
        .paraphraser-textarea {
            resize: none;
        }
        .paraphraser-mode.active {
            background-color: #4f46e5;
            color: white;
        }
        html.dark .paraphraser-mode.active {
            background-color: #6366f1;
        }
        #paraphraserModeContainer::-webkit-scrollbar {
            height: 4px;
        }
    </style>
</head>
<body class="bg-slate-100 dark:bg-slate-900 text-slate-800 dark:text-slate-200">

    <div id="loading-overlay" class="bg-white dark:bg-slate-900">
        <i class="fas fa-spinner fa-spin text-indigo-600 text-4xl"></i>
    </div>

    <div id="app-wrapper">
        <div id="main-view" class="flex h-screen bg-white dark:bg-slate-800">
            <!-- Sidebar -->
            <aside class="w-64 flex-shrink-0 bg-slate-50 dark:bg-slate-900 border-r border-slate-200 dark:border-slate-700 flex flex-col">
                <div class="h-14 flex items-center px-4 border-b border-slate-200 dark:border-slate-700">
                    <i class="fas fa-tasks text-indigo-600 text-xl"></i>
                    <h1 class="text-lg font-bold ml-2 text-slate-800 dark:text-slate-200">TaskFlow</h1>
                </div>

                <nav id="sidebarNav" class="flex-1 px-3 py-3 space-y-1 overflow-y-auto">
                    <a href="#" class="sidebar-link flex items-center px-3 py-1.5 text-slate-700 dark:text-slate-300 rounded-md" data-id="home" data-title="Today's Tasks">
                        <i class="fas fa-home w-5 text-center text-sm"></i><span class="ml-2 text-sm">Home</span>
                    </a>
                    <a href="#" class="sidebar-link flex items-center px-3 py-1.5 text-slate-600 dark:text-slate-400 hover:bg-slate-200 dark:hover:bg-slate-700 rounded-md" data-id="upcoming" data-title="Upcoming Tasks">
                        <i class="fas fa-calendar-alt w-5 text-center text-sm"></i><span class="ml-2 text-sm">Upcoming</span>
                    </a>
                    <div class="pt-3">
                        <div class="flex items-center justify-between px-3">
                            <h2 class="text-xs font-semibold text-slate-400 dark:text-slate-500 uppercase tracking-wider">Projects</h2>
                            <button id="addProjectBtn" class="text-slate-400 dark:text-slate-500 hover:text-indigo-600 dark:hover:text-indigo-400" title="Add new project"><i class="fas fa-plus-circle text-base"></i></button>
                        </div>
                        <div id="projectList" class="mt-2 space-y-0.5">
                            <p class="text-slate-400 dark:text-slate-500 text-xs px-3 py-2">Loading projects...</p>
                        </div>
                    </div>
                </nav>
                
                <div id="auth-container" class="p-3 border-t border-slate-200 dark:border-slate-700">
                    <!-- This will be populated by JS -->
                </div>
            </aside>

            <!-- Main Content -->
            <main class="flex-1 p-4 sm:p-5 lg:p-6 bg-slate-100 dark:bg-slate-900 overflow-y-auto">
                <header class="flex items-center justify-between mb-6 gap-3">
                    <div>
                        <h2 id="mainHeader" class="text-3xl font-semibold text-slate-800 dark:text-slate-200"></h2>
                        <p class="text-slate-500 dark:text-slate-400 text-sm mt-1" id="currentDate"></p>
                    </div>
                    <div class="flex items-center gap-2">
                        <button id="liveMeetingBtn" class="flex items-center justify-center bg-green-500 hover:bg-green-600 text-white font-bold py-1.5 px-3 rounded-md shadow-sm transition-transform transform hover:scale-105 text-sm">
                            <i class="fas fa-video mr-2 text-xs"></i>Live Meeting
                        </button>
                        <button id="theme-toggle" class="h-9 w-9 flex items-center justify-center rounded-full text-slate-500 dark:text-slate-400 hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors">
                            <i id="theme-icon" class="fas"></i>
                        </button>
                        <button id="addTaskBtn" class="flex items-center justify-center bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-1.5 px-3 rounded-md shadow-sm transition-transform transform hover:scale-105 text-sm"><i class="fas fa-plus mr-2 text-xs"></i>Add Task</button>
                    </div>
                </header>

                <!-- AI Assistant Section -->
                <div id="ai-assistant-bar" class="mb-4 p-3 rounded-lg shadow-lg flex items-center justify-between flex-wrap gap-x-6 gap-y-2">
                    <div class="flex items-center gap-2 text-white font-bold">
                        <i class="fas fa-wand-magic-sparkles"></i>
                        <span>AI Assistant:</span>
                    </div>
                    <div class="flex items-center gap-x-4 gap-y-2 flex-wrap">
                        <button data-tool="paraphraser" class="ai-feature-btn text-white/80 hover:text-white transition-colors text-sm flex items-center gap-1.5">
                            <i class="fas fa-paragraph text-xs"></i><span>Paraphraser</span>
                        </button>
                        <button data-tool="email" class="ai-feature-btn text-white/80 hover:text-white transition-colors text-sm flex items-center gap-1.5">
                            <i class="fas fa-envelope-open-text text-xs"></i><span>Email Writer</span>
                        </button>
                        <button data-tool="invoice" class="ai-feature-btn text-white/80 hover:text-white transition-colors text-sm flex items-center gap-1.5">
                            <i class="fas fa-file-invoice-dollar text-xs"></i><span>Invoice Gen</span>
                        </button>
                        <button data-tool="idea" class="ai-feature-btn text-white/80 hover:text-white transition-colors text-sm flex items-center gap-1.5">
                            <i class="fas fa-lightbulb text-xs"></i><span>Idea Gen</span>
                        </button>
                    </div>
                </div>
                
                <div id="summaryBar" class="mb-4"></div>

                <div id="taskList" class="space-y-3">
                     <p class="text-slate-500 dark:text-slate-400 text-center py-6 text-sm">Loading tasks...</p>
                </div>

            </main>
        </div>

        <div id="task-detail-page" class="hidden p-4 sm:p-5 lg:p-6 bg-slate-100 dark:bg-slate-900 overflow-y-auto">
            <header class="flex items-center justify-between mb-6">
                <button id="backToTasksBtn" class="flex items-center text-slate-500 dark:text-slate-400 hover:text-indigo-600 dark:hover:text-indigo-400">
                    <i class="fas fa-arrow-left mr-2"></i>
                    Back to Tasks
                </button>
                <div class="flex items-center gap-3">
                    <button type="button" id="requestRevisionBtn" class="px-4 py-1.5 bg-amber-500 text-white rounded-md text-sm">Revisions</button>
                    <button type="button" id="markDeliveredBtn" class="px-4 py-1.5 bg-sky-500 text-white rounded-md text-sm">Mark as Delivered</button>
                    <button type="button" id="markCompletedBtn" class="px-4 py-1.5 bg-green-500 text-white rounded-md text-sm">Mark as Completed</button>
                    <button type="button" id="editDetailBtn" class="px-5 py-1.5 bg-indigo-600 text-white rounded-md text-sm">Edit Task</button>
                </div>
            </header>
            <div class="bg-white dark:bg-slate-800 rounded-lg shadow-xl p-6">
                <h3 id="detailTaskName" class="text-2xl font-bold text-slate-800 dark:text-slate-200"></h3>
                <div class="space-y-4 mt-4">
                    <div>
                        <h4 class="text-sm font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-wider">Description</h4>
                        <p id="detailTaskDescription" class="mt-1 text-slate-700 dark:text-slate-300 whitespace-pre-wrap"></p>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 border-t border-slate-200 dark:border-slate-700 pt-4">
                        <div>
                            <h4 class="text-sm font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-wider">Due Date</h4>
                            <p id="detailTaskDueDate" class="mt-1 text-slate-700 dark:text-slate-300"></p>
                        </div>
                        <div>
                            <h4 class="text-sm font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-wider">Project</h4>
                            <p id="detailTaskProject" class="mt-1 text-slate-700 dark:text-slate-300"></p>
                        </div>
                        <div>
                            <h4 class="text-sm font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-wider">Status</h4>
                            <p id="detailTaskStatus" class="mt-1 text-slate-700 dark:text-slate-300"></p>
                        </div>
                    </div>
                     <div>
                        <h4 class="text-sm font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-wider">Notes</h4>
                        <div id="detailTaskNotes" class="mt-1 p-3 bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800/50 rounded-md text-slate-700 dark:text-yellow-200 whitespace-pre-wrap"></div>
                    </div>
                    <div id="subtask-section">
                        <h4 class="text-sm font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-wider">Checklist</h4>
                        <div id="subtaskList" class="mt-2 space-y-2"></div>
                        <form id="subtaskForm" class="mt-2 flex gap-2">
                            <input type="text" id="subtaskInput" class="w-full px-3 py-1.5 border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 rounded-md text-sm" placeholder="Add a sub-task...">
                            <button type="submit" class="px-4 py-1.5 bg-indigo-500 text-white rounded-md text-sm">Add</button>
                        </form>
                    </div>
                    <div id="revision-section">
                        <h4 class="text-sm font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-wider">Revision History</h4>
                        <div id="revisionList" class="mt-2 space-y-2"></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="completed-tasks-view" class="hidden p-4 sm:p-5 lg:p-6 bg-slate-100 dark:bg-slate-900 overflow-y-auto">
            <header class="flex items-center justify-between mb-6">
                <button id="backToMainFromCompleted" class="flex items-center text-slate-500 dark:text-slate-400 hover:text-indigo-600 dark:hover:text-indigo-400">
                    <i class="fas fa-arrow-left mr-2"></i>
                    Back to Main View
                </button>
                <h2 class="text-2xl font-semibold text-slate-800 dark:text-slate-200">Completed Tasks</h2>
                 <div></div>
            </header>
            <div id="completedTaskList" class="space-y-3"></div>
        </div>
    </div>
    
    <!-- Modals -->
    <div id="aiHubModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
        <div class="bg-white dark:bg-slate-800 rounded-lg shadow-xl w-full max-w-6xl flex" style="height: 90vh;">
            <!-- AI Hub Navigation -->
            <nav class="w-48 flex-shrink-0 bg-slate-50 dark:bg-slate-900/50 p-4 border-r border-slate-200 dark:border-slate-700">
                <h3 class="text-lg font-bold text-slate-900 dark:text-slate-200 mb-4">AI Tools</h3>
                <div id="ai-tools-nav" class="space-y-1">
                    <button data-tool="paraphraser" class="ai-tool-nav-btn active w-full flex items-center text-left px-3 py-1.5 rounded-md text-sm">
                        <i class="fas fa-paragraph w-5 text-center text-xs"></i><span class="ml-2">Paraphraser</span>
                    </button>
                    <button data-tool="grammar" class="ai-tool-nav-btn w-full flex items-center text-left px-3 py-1.5 rounded-md text-sm">
                        <i class="fas fa-spell-check w-5 text-center text-xs"></i><span class="ml-2">Grammar</span>
                    </button>
                    <button data-tool="chat" class="ai-tool-nav-btn w-full flex items-center text-left px-3 py-1.5 rounded-md text-sm">
                        <i class="fas fa-comments w-5 text-center text-xs"></i><span class="ml-2">AI Chat</span>
                    </button>
                    <button data-tool="translate" class="ai-tool-nav-btn w-full flex items-center text-left px-3 py-1.5 rounded-md text-sm">
                        <i class="fas fa-language w-5 text-center text-xs"></i><span class="ml-2">Translate</span>
                    </button>
                    <button data-tool="summarize" class="ai-tool-nav-btn w-full flex items-center text-left px-3 py-1.5 rounded-md text-sm">
                        <i class="fas fa-compress-alt w-5 text-center text-xs"></i><span class="ml-2">Summarizer</span>
                    </button>
                </div>
            </nav>
            <!-- AI Hub Content -->
            <div id="ai-hub-content" class="flex-1 flex flex-col">
                <!-- Paraphraser Tool -->
                <div id="paraphraser-tool" class="ai-tool-content flex flex-col h-full">
                     <main class="flex-1 p-4 grid grid-cols-1 md:grid-cols-2 gap-4 overflow-hidden">
                        <div class="flex flex-col">
                            <textarea id="paraphraserInput" class="paraphraser-textarea w-full flex-1 p-3 border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 rounded-md" placeholder="Enter text to paraphrase..."></textarea>
                            <div id="inputWordCount" class="text-xs text-slate-500 dark:text-slate-400 mt-1 text-right">0 words / 0 characters</div>
                        </div>
                        <div class="flex flex-col">
                            <div id="paraphraserOutputContainer" class="w-full flex-1 p-3 border border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700/50 rounded-md relative">
                                <textarea id="paraphraserOutput" class="paraphraser-textarea w-full h-full bg-transparent" placeholder="Paraphrased text will appear here..."></textarea>
                                <button id="copyOutputBtn" class="absolute top-2 right-2 px-2 py-1 bg-slate-200 dark:bg-slate-600 text-xs rounded-md hover:bg-slate-300 dark:hover:bg-slate-500"><i class="fas fa-copy mr-1"></i>Copy</button>
                            </div>
                            <div id="outputWordCount" class="text-xs text-slate-500 dark:text-slate-400 mt-1 text-right">0 words / 0 characters</div>
                        </div>
                    </main>
                    <footer class="p-4 border-t border-slate-200 dark:border-slate-700 flex-shrink-0 flex items-center justify-between flex-wrap gap-4">
                        <div class="flex items-center gap-2 flex-grow">
                            <span class="text-sm font-medium">Mode:</span>
                            <div id="paraphraserModeContainer" class="flex items-center bg-slate-200 dark:bg-slate-700 rounded-lg p-0.5 text-xs overflow-x-auto">
                                <button class="paraphraser-mode active px-3 py-1 rounded-md flex-shrink-0" data-mode="Standard">Standard</button>
                                <button class="paraphraser-mode px-3 py-1 rounded-md flex-shrink-0" data-mode="Fluent">Fluent</button>
                                <button class="paraphraser-mode px-3 py-1 rounded-md flex-shrink-0" data-mode="Formal">Formal</button>
                                <button class="paraphraser-mode px-3 py-1 rounded-md flex-shrink-0" data-mode="Simple">Simple</button>
                                <button class="paraphraser-mode px-3 py-1 rounded-md flex-shrink-0" data-mode="Creative">Creative</button>
                                <button class="paraphraser-mode px-3 py-1 rounded-md flex-shrink-0" data-mode="Expand">Expand</button>
                                <button class="paraphraser-mode px-3 py-1 rounded-md flex-shrink-0" data-mode="Shorten">Shorten</button>
                            </div>
                        </div>
                        <button id="paraphraseBtn" class="px-6 py-2 bg-indigo-600 text-white font-bold rounded-lg hover:bg-indigo-700 flex items-center gap-2">
                            <span id="paraphraseBtnText">Paraphrase</span>
                            <i id="paraphraseBtnIcon" class="fas fa-arrow-right"></i>
                        </button>
                    </footer>
                </div>
                <!-- Other tools (placeholders) -->
                <div id="grammar-tool" class="ai-tool-content hidden p-6 text-center">Grammar Checker Coming Soon...</div>
                <div id="chat-tool" class="ai-tool-content hidden p-6 text-center">AI Chat Coming Soon...</div>
                <div id="translate-tool" class="ai-tool-content hidden p-6 text-center">Translator Coming Soon...</div>
                <div id="summarize-tool" class="ai-tool-content hidden p-6 text-center">Summarizer Coming Soon...</div>
                <button id="closeAiHubBtn" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600 dark:hover:text-slate-200"><i class="fas fa-times text-2xl"></i></button>
            </div>
        </div>
    </div>

    <div id="profileSettingsModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
        <div class="bg-white dark:bg-slate-800 rounded-lg shadow-xl p-6 w-full max-w-lg">
            <h3 class="text-xl font-bold mb-5 text-slate-900 dark:text-slate-200">Profile Settings</h3>
            <form id="profileSettingsForm">
                <div class="flex items-center gap-6">
                    <div class="flex-shrink-0">
                        <img id="profileImagePreview" class="h-24 w-24 rounded-full object-cover" src="https://placehold.co/100x100/E2E8F0/475569?text=?" alt="User avatar">
                        <label for="profileImageUpload" class="mt-2 text-sm text-indigo-600 dark:text-indigo-400 hover:text-indigo-500 cursor-pointer text-center block">Change</label>
                        <input type="file" id="profileImageUpload" class="hidden" accept="image/*">
                    </div>
                    <div class="space-y-4 flex-1">
                        <div>
                            <label for="profileName" class="block text-xs font-medium text-slate-700 dark:text-slate-300 mb-1">Name</label>
                            <input type="text" id="profileName" class="w-full px-3 py-1.5 border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 rounded-md text-sm">
                        </div>
                        <div>
                            <label for="profileUsername" class="block text-xs font-medium text-slate-700 dark:text-slate-300 mb-1">Username</label>
                            <input type="text" id="profileUsername" class="w-full px-3 py-1.5 border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 rounded-md text-sm" required>
                        </div>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                    <div>
                        <label for="profileEmail" class="block text-xs font-medium text-slate-700 dark:text-slate-300 mb-1">Email</label>
                        <input type="email" id="profileEmail" class="w-full px-3 py-1.5 border border-slate-300 dark:border-slate-600 bg-slate-100 dark:bg-slate-700 rounded-md text-sm" disabled>
                    </div>
                    <div>
                        <label for="profilePhone" class="block text-xs font-medium text-slate-700 dark:text-slate-300 mb-1">Phone Number</label>
                        <input type="tel" id="profilePhone" class="w-full px-3 py-1.5 border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 rounded-md text-sm">
                    </div>
                </div>
                <div class="flex justify-end space-x-3 pt-5 mt-4 border-t border-slate-200 dark:border-slate-700">
                    <button type="button" id="cancelProfileSettingsBtn" class="px-4 py-1.5 bg-slate-200 text-slate-800 dark:bg-slate-600 dark:text-slate-200 rounded-md text-sm">Cancel</button>
                    <button type="submit" class="px-5 py-1.5 bg-indigo-600 text-white rounded-md text-sm">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <div id="signInModal" class="fixed inset-0 bg-gray-900 bg-opacity-60 hidden items-center justify-center z-50 p-4 backdrop-blur-sm">
        <div class="bg-white/95 dark:bg-slate-800/95 rounded-xl shadow-2xl p-6 w-full max-w-sm">
            <div class="text-center mb-6">
                 <i class="fas fa-tasks text-indigo-600 text-3xl"></i>
                <h1 class="text-xl font-bold text-gray-800 dark:text-gray-200 mt-2">TaskFlow</h1>
            </div>
            <h2 id="authModalTitle" class="text-xl font-bold text-slate-800 dark:text-slate-200 mb-5 text-left">Login</h2>
            <form id="authForm" class="space-y-3">
                <div id="registerFields" class="hidden space-y-3">
                     <div>
                        <label for="authUsername" class="block text-xs font-medium text-slate-700 dark:text-slate-300 text-left mb-1">Username</label>
                        <input type="text" id="authUsername" class="w-full px-3 py-1.5 border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 rounded-md text-sm" autocomplete="username">
                    </div>
                </div>
                <div>
                    <label for="authEmail" class="block text-xs font-medium text-slate-700 dark:text-slate-300 text-left mb-1">Email</label>
                    <input type="email" id="authEmail" class="w-full px-3 py-1.5 border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 rounded-md text-sm" required autocomplete="email">
                </div>
                <div>
                    <label for="authPassword" class="block text-xs font-medium text-slate-700 dark:text-slate-300 text-left mb-1">Password</label>
                    <input type="password" id="authPassword" class="w-full px-3 py-1.5 border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 rounded-md text-sm" required autocomplete="current-password">
                </div>
                <div id="authOptions" class="flex justify-between items-center text-xs">
                    <label class="flex items-center text-slate-600 dark:text-slate-400">
                        <input type="checkbox" id="authPersistence" class="h-3.5 w-3.5 rounded border-gray-300 dark:border-slate-600 text-indigo-600 bg-gray-100 dark:bg-slate-700">
                        <span class="ml-2">Remember me</span>
                    </label>
                    <a href="#" id="forgotPasswordLink" class="font-semibold text-indigo-600 dark:text-indigo-400 hover:underline">Forgot Password?</a>
                </div>
                <div id="policyField" class="hidden text-left">
                    <label class="flex items-center text-xs text-slate-600 dark:text-slate-400">
                        <input type="checkbox" id="authPolicy" class="h-3.5 w-3.5 rounded border-gray-300 dark:border-slate-600 text-indigo-600 bg-gray-100 dark:bg-slate-700">
                        <span class="ml-2">I agree to the <a href="#" class="text-indigo-600 dark:text-indigo-400 hover:underline">Terms & Policy</a>.</span>
                    </label>
                </div>
                <div id="authError" class="text-red-500 text-xs text-center h-3"></div>
                <button id="authSubmitBtn" type="submit" class="w-full bg-indigo-600 text-white font-bold py-2 px-4 rounded-md hover:bg-indigo-700 transition-colors text-base mt-2">
                    Sign In
                </button>
            </form>
             <div class="flex items-center my-4">
                <div class="flex-grow border-t border-gray-300 dark:border-slate-600"></div>
                <span class="flex-shrink mx-3 text-gray-400 dark:text-slate-500 text-xs">or continue with</span>
                <div class="flex-grow border-t border-gray-300 dark:border-slate-600"></div>
            </div>
            <div class="flex justify-center space-x-3">
                <button data-provider="google" class="social-login-btn w-10 h-10 border border-gray-300 dark:border-slate-600 rounded-md flex items-center justify-center hover:bg-gray-100 dark:hover:bg-slate-700"><i class="fab fa-google text-lg"></i></button>
                <button data-provider="apple" class="social-login-btn w-10 h-10 border border-gray-300 dark:border-slate-600 rounded-md flex items-center justify-center hover:bg-gray-100 dark:hover:bg-slate-700"><i class="fab fa-apple text-lg"></i></button>
                <button data-provider="github" class="social-login-btn w-10 h-10 border border-gray-300 dark:border-slate-600 rounded-md flex items-center justify-center hover:bg-gray-100 dark:hover:bg-slate-700"><i class="fab fa-github text-lg"></i></button>
            </div>
            <p class="text-center text-xs text-slate-500 dark:text-slate-400 mt-5">
                <span id="authToggleText">Don't have an account?</span>
                <a href="#" id="authToggleLink" class="font-semibold text-indigo-600 dark:text-indigo-400 hover:text-indigo-500">Register for free</a>
            </p>
        </div>
    </div>

    <div id="taskModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
        <div class="bg-white dark:bg-slate-800 rounded-lg shadow-xl p-6 w-full max-w-3xl">
            <h3 id="taskModalTitle" class="text-xl font-bold mb-5 text-slate-900 dark:text-slate-200">Add a New Task</h3>
            <form id="taskForm">
                <input type="hidden" id="taskId">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Left Column -->
                    <div class="space-y-4">
                        <div>
                            <label for="taskName" class="block text-xs font-medium text-slate-700 dark:text-slate-300 mb-1">Task Name</label>
                            <div class="input-with-icon">
                                <i class="fas fa-tasks text-slate-400"></i>
                                <input type="text" id="taskName" class="w-full px-3 py-1.5 border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 rounded-md text-sm" required>
                            </div>
                        </div>
                        <div>
                            <label for="taskDescription" class="block text-xs font-medium text-slate-700 dark:text-slate-300 mb-1">Description / Instructions</label>
                            <textarea id="taskDescription" rows="5" class="w-full px-3 py-1.5 border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 rounded-md text-sm" placeholder="Add more details about the task..."></textarea>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-slate-700 dark:text-slate-300 mb-1">Attachments</label>
                            <div class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-slate-300 dark:border-slate-600 border-dashed rounded-md">
                                <div class="space-y-1 text-center">
                                    <i class="fas fa-paperclip text-3xl text-slate-400"></i>
                                    <div class="flex text-sm text-slate-600 dark:text-slate-400">
                                        <label for="file-upload" class="relative cursor-pointer bg-white dark:bg-slate-800 rounded-md font-medium text-indigo-600 dark:text-indigo-400 hover:text-indigo-500 focus-within:outline-none">
                                            <span>Upload a file</span>
                                            <input id="file-upload" name="file-upload" type="file" class="sr-only">
                                        </label>
                                        <p class="pl-1">or drag and drop</p>
                                    </div>
                                    <p class="text-xs text-slate-500 dark:text-slate-500">PNG, JPG, PDF up to 10MB</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Right Column -->
                    <div class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="taskDueDate" class="block text-xs font-medium text-slate-700 dark:text-slate-300 mb-1">Due Date</label>
                                <input type="date" id="taskDueDate" class="w-full px-3 py-1.5 border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 rounded-md text-sm">
                            </div>
                            <div>
                                <label for="taskDueTime" class="block text-xs font-medium text-slate-700 dark:text-slate-300 mb-1">Due Time</label>
                                <input type="time" id="taskDueTime" class="w-full px-3 py-1.5 border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 rounded-md text-sm">
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label for="taskProject" class="block text-xs font-medium text-slate-700 dark:text-slate-300 mb-1">Project</label>
                                <select id="taskProject" class="w-full px-3 py-1.5 border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 rounded-md text-sm"></select>
                            </div>
                            <div>
                                <label for="taskPriority" class="block text-xs font-medium text-slate-700 dark:text-slate-300 mb-1">Priority</label>
                                <select id="taskPriority" class="w-full px-3 py-1.5 border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 rounded-md text-sm"><option>Low</option><option selected>Medium</option><option>High</option></select>
                            </div>
                            <div>
                                <label for="taskStatus" class="block text-xs font-medium text-slate-700 dark:text-slate-300 mb-1">Status</label>
                                <select id="taskStatus" class="w-full px-3 py-1.5 border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 rounded-md text-sm"><option>To Do</option><option>In Progress</option><option>Needs Revision</option><option>Delivered</option><option>Completed</option></select>
                            </div>
                        </div>
                        <div>
                            <label for="taskNotes" class="block text-xs font-medium text-slate-700 dark:text-slate-300 mb-1">Notes</label>
                            <textarea id="taskNotes" rows="6" class="w-full px-3 py-1.5 border border-yellow-200 dark:border-yellow-800/50 bg-yellow-50 dark:bg-yellow-900/20 rounded-md text-sm" placeholder="Add a quick note..."></textarea>
                        </div>
                    </div>
                </div>
                <div class="flex justify-end space-x-3 pt-5">
                    <button type="button" id="cancelTaskBtn" class="px-4 py-1.5 bg-slate-200 text-slate-800 dark:bg-slate-600 dark:text-slate-200 rounded-md text-sm">Cancel</button>
                    <button type="submit" id="taskSubmitBtn" class="px-5 py-1.5 bg-indigo-600 text-white rounded-md text-sm">Add Task</button>
                </div>
            </form>
        </div>
    </div>

    <div id="revisionModal" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center z-[60] p-4">
        <div class="bg-white dark:bg-slate-800 rounded-lg shadow-xl p-6 w-full max-w-md">
            <h3 class="text-xl font-bold mb-5 text-slate-900 dark:text-slate-200">Request Revision</h3>
            <form id="revisionForm">
                <div>
                    <label for="revisionNote" class="block text-xs font-medium text-slate-700 dark:text-slate-300 mb-1">Revision Note</label>
                    <textarea id="revisionNote" rows="4" class="w-full px-3 py-1.5 border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 rounded-md text-sm" required></textarea>
                </div>
                <div class="flex justify-end space-x-3 pt-5">
                    <button type="button" id="cancelRevisionBtn" class="px-4 py-1.5 bg-slate-200 text-slate-800 dark:bg-slate-600 dark:text-slate-200 rounded-md text-sm">Cancel</button>
                    <button type="submit" class="px-5 py-1.5 bg-amber-500 text-white rounded-md text-sm">Submit</button>
                </div>
            </form>
        </div>
    </div>

    <div id="projectModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
        <div class="bg-white dark:bg-slate-800 rounded-lg shadow-xl p-6 w-full max-w-sm">
            <h3 id="projectModalTitle" class="text-xl font-bold mb-5 dark:text-slate-200">Add a New Project</h3>
            <form id="projectForm">
                <input type="hidden" id="projectId">
                <div class="mb-5">
                    <label for="projectName" class="block text-xs font-medium text-slate-700 dark:text-slate-300 mb-1">Project Name</label>
                    <input type="text" id="projectName" class="w-full px-3 py-1.5 border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 rounded-md text-sm" required>
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" id="cancelProjectBtn" class="px-4 py-1.5 bg-slate-200 text-slate-800 dark:bg-slate-600 dark:text-slate-200 rounded-md text-sm">Cancel</button>
                    <button type="submit" id="projectSubmitBtn" class="px-4 py-1.5 bg-indigo-600 text-white rounded-md text-sm">Create</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="subProjectModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
        <div class="bg-white dark:bg-slate-800 rounded-lg shadow-xl p-6 w-full max-w-sm">
            <h3 id="subProjectModalTitle" class="text-xl font-bold mb-5 dark:text-slate-200">Add New Item</h3>
            <form id="subProjectForm">
                <input type="hidden" id="subProjectId">
                <input type="hidden" id="parentProjectId">
                <div class="mb-5">
                    <label for="subProjectName" class="block text-xs font-medium text-slate-700 dark:text-slate-300 mb-1">Item Name</label>
                    <input type="text" id="subProjectName" class="w-full px-3 py-1.5 border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 rounded-md text-sm" required>
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" id="cancelSubProjectBtn" class="px-4 py-1.5 bg-slate-200 text-slate-800 dark:bg-slate-600 dark:text-slate-200 rounded-md text-sm">Cancel</button>
                    <button type="submit" id="subProjectSubmitBtn" class="px-4 py-1.5 bg-indigo-600 text-white rounded-md text-sm">Create</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast-notification" class="bg-slate-800 dark:bg-slate-200 text-white dark:text-slate-800 text-sm font-semibold py-2 px-4 rounded-full shadow-lg">
        <i class="fas fa-info-circle mr-2"></i>
        <span id="toast-message"></span>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, setPersistence, browserLocalPersistence, browserSessionPersistence, sendPasswordResetEmail, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, addDoc, updateDoc, deleteDoc, onSnapshot, collection, query, getDocs, writeBatch, arrayUnion, arrayRemove, Timestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        // ===================================================================================
        // ============================ FIREBASE CONFIGURATION ===============================
        // ===================================================================================
        //
        //  YOUR FIREBASE CONFIGURATION OBJECT
        //
        const firebaseConfig = {
          apiKey: "AIzaSyBXx77dhZQAmVocuulRX_G6h7mycSiYprY",
          authDomain: "gowafir-taskflow.firebaseapp.com",
          projectId: "gowafir-taskflow",
          storageBucket: "gowafir-taskflow.appspot.com",
          messagingSenderId: "970559027923",
          appId: "1:970559027923:web:0a37d1fbb446623064f226",
          measurementId: "G-KZFBXZLYC4"
        };
        //
        // ===================================================================================
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const storage = getStorage(app);

        // --- LOCAL STATE ---
        let localState = {
            projects: [],
            tasks: [],
            activeView: { type: 'home', id: 'home', title: "Today's Tasks" },
            editing: { type: null, id: null },
            userId: null,
            projectsUnsubscribe: null,
            tasksUnsubscribe: null,
            isRegisterMode: false,
        };

        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM ELEMENTS ---
            const loadingOverlay = document.getElementById('loading-overlay');
            const mainView = document.getElementById('main-view');
            const taskDetailPage = document.getElementById('task-detail-page');
            const completedTasksView = document.getElementById('completed-tasks-view');
            const mainHeader = document.getElementById('mainHeader');
            const taskListEl = document.getElementById('taskList');
            const summaryBarEl = document.getElementById('summaryBar');
            const projectListEl = document.getElementById('projectList');
            const sidebarNav = document.getElementById('sidebarNav');
            const taskModal = document.getElementById('taskModal');
            const projectModal = document.getElementById('projectModal');
            const subProjectModal = document.getElementById('subProjectModal');
            const signInModal = document.getElementById('signInModal');
            const authContainer = document.getElementById('auth-container');
            const authForm = document.getElementById('authForm');
            const taskFormEl = document.getElementById('taskForm');
            const projectForm = document.getElementById('projectForm');
            const subProjectForm = document.getElementById('subProjectForm');
            const authToggleLink = document.getElementById('authToggleLink');
            const profileSettingsModal = document.getElementById('profileSettingsModal');
            const profileSettingsForm = document.getElementById('profileSettingsForm');
            const cancelProfileSettingsBtn = document.getElementById('cancelProfileSettingsBtn');
            const revisionModal = document.getElementById('revisionModal');
            const revisionForm = document.getElementById('revisionForm');
            const cancelRevisionBtn = document.getElementById('cancelRevisionBtn');
            const themeToggleBtn = document.getElementById('theme-toggle');
            const themeIcon = document.getElementById('theme-icon');
            const toastNotification = document.getElementById('toast-notification');
            const toastMessage = document.getElementById('toast-message');
            const aiHubModal = document.getElementById('aiHubModal');
            const liveMeetingBtn = document.getElementById('liveMeetingBtn');
            
            // --- THEME LOGIC ---
            function updateThemeIcon(theme) {
                if (theme === 'dark') {
                    themeIcon.classList.remove('fa-moon');
                    themeIcon.classList.add('fa-sun');
                } else {
                    themeIcon.classList.remove('fa-sun');
                    themeIcon.classList.add('fa-moon');
                }
            }

            themeToggleBtn.addEventListener('click', () => {
                const isDark = document.documentElement.classList.toggle('dark');
                const newTheme = isDark ? 'dark' : 'light';
                localStorage.setItem('theme', newTheme);
                updateThemeIcon(newTheme);
            });

            // --- TOAST NOTIFICATION ---
            let toastTimeout;
            function showToast(message) {
                clearTimeout(toastTimeout);
                toastMessage.textContent = message;
                toastNotification.classList.add('show');
                toastTimeout = setTimeout(() => {
                    toastNotification.classList.remove('show');
                }, 3000);
            }

            // --- RENDER FUNCTIONS ---
            function renderAll() {
                renderProjects();
                renderTasks();
                updateProjectDropdown();
            }

            function renderProjects() {
                if (!localState.userId) {
                    projectListEl.innerHTML = '';
                    return;
                }
                if (localState.projects.length === 0) {
                    projectListEl.innerHTML = `<p class="text-slate-400 dark:text-slate-500 text-xs px-3 py-2">No projects yet.</p>`;
                    return;
                }
                projectListEl.innerHTML = '';
                localState.projects.forEach(p => {
                    const projectEl = document.createElement('div');
                    projectEl.className = 'project-item';
                    projectEl.dataset.id = p.id;
                    projectEl.innerHTML = `
                        <div class="flex items-center justify-between w-full rounded-md hover:bg-slate-200 dark:hover:bg-slate-700">
                            <div class="relative">
                                <button class="action-menu-btn text-slate-400 dark:text-slate-500 hover:text-slate-600 dark:hover:text-slate-300 p-1.5 rounded-md"><i class="fas fa-ellipsis-v text-xs"></i></button>
                                <div class="action-menu bg-white dark:bg-slate-800 rounded-md shadow-lg border border-slate-200 dark:border-slate-700">
                                    <button class="action-menu-item edit-btn text-slate-700 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700"><i class="fas fa-pencil-alt"></i>Edit</button>
                                    <button class="action-menu-item delete-btn text-slate-700 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700"><i class="fas fa-trash-alt"></i>Delete</button>
                                </div>
                            </div>
                            <a href="#" class="sidebar-link flex-1 flex items-center px-1.5 py-1.5 text-slate-600 dark:text-slate-300 rounded-md" data-id="${p.id}" data-title="${p.name}">
                                <div class="flex items-center"><span class="w-1.5 h-1.5 bg-purple-500 rounded-full"></span><span class="ml-2 project-name text-sm">${p.name}</span></div>
                            </a>
                            <i class="fas fa-chevron-down text-xs transition-transform p-1.5 cursor-pointer expand-btn text-slate-400"></i>
                        </div>
                        <div class="submenu ml-5 space-y-0.5 py-1">
                            ${(p.subProjects || []).map(sp => `
                                <div class="sub-project-item flex items-center justify-between w-full rounded-md hover:bg-slate-200 dark:hover:bg-slate-700" data-id="${sp.id}" data-parent-id="${p.id}">
                                    <div class="relative">
                                        <button class="action-menu-btn text-slate-400 dark:text-slate-500 hover:text-slate-600 dark:hover:text-slate-300 p-1.5 rounded-md"><i class="fas fa-ellipsis-v text-xxs"></i></button>
                                        <div class="action-menu bg-white dark:bg-slate-800 rounded-md shadow-lg border border-slate-200 dark:border-slate-700">
                                            <button class="action-menu-item edit-btn text-slate-700 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700"><i class="fas fa-pencil-alt"></i>Edit</button>
                                            <button class="action-menu-item delete-btn text-slate-700 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700"><i class="fas fa-trash-alt"></i>Delete</button>
                                        </div>
                                    </div>
                                    <a href="#" class="sidebar-link flex-1 block px-2 py-1 text-xs text-slate-500 dark:text-slate-400 rounded-md" data-id="${sp.id}" data-title="${sp.name}">${sp.name}</a>
                                </div>
                            `).join('')}
                            <button class="add-sub-project-btn flex items-center w-full text-left px-2 py-1 text-xs text-slate-400 dark:text-slate-500 hover:text-indigo-600 dark:hover:text-indigo-400 rounded-md"><i class="fas fa-plus mr-1.5 text-xxs"></i>Add item</button>
                        </div>`;
                    projectListEl.appendChild(projectEl);
                });
            }
            
            function renderTasks() {
                if (!localState.userId) {
                    renderLoginPrompt();
                    return;
                }
                const activeTasks = localState.tasks.filter(t => t.status !== 'Completed');
                let tasksToRender = [];
                
                if (localState.activeView.type === 'home' || localState.activeView.type === 'upcoming') {
                    tasksToRender = activeTasks;
                } else if (localState.activeView.type === 'project') {
                    const proj = localState.projects.find(p => p.id === localState.activeView.id);
                    if(proj) {
                        const subProjectIds = (proj.subProjects || []).map(sp => sp.id);
                        tasksToRender = activeTasks.filter(t => t.projectId === proj.id || subProjectIds.includes(t.projectId));
                    }
                } else if (localState.activeView.type === 'sub-project') {
                    tasksToRender = activeTasks.filter(t => t.projectId === localState.activeView.id);
                }
                
                if (tasksToRender.length === 0) {
                    taskListEl.innerHTML = `<p class="text-slate-500 dark:text-slate-400 text-center py-6 text-sm">No active tasks in this view.</p>`;
                    return;
                }

                taskListEl.innerHTML = '';
                tasksToRender.forEach(t => {
                    const priorityColors = { High: 'text-red-500', Medium: 'text-orange-500', Low: 'text-green-500' };
                    const statusColors = { 
                        'To Do': 'bg-slate-200 text-slate-600 dark:bg-slate-600 dark:text-slate-200', 
                        'In Progress': 'bg-blue-100 text-blue-600 dark:bg-blue-900/50 dark:text-blue-300', 
                        'Needs Revision': 'bg-amber-100 text-amber-600 dark:bg-amber-900/50 dark:text-amber-300', 
                        'Delivered': 'bg-purple-100 text-purple-600 dark:bg-purple-900/50 dark:text-purple-300', 
                        'Completed': 'bg-green-100 text-green-600 dark:bg-green-900/50 dark:text-green-300' 
                    };
                    
                    let mainProjectName = '';
                    for (const p of localState.projects) {
                        if (p.id === t.projectId) { mainProjectName = p.name; break; }
                        const sp = (p.subProjects || []).find(sp => sp.id === t.projectId);
                        if (sp) { mainProjectName = p.name; break; }
                    }

                    const taskEl = document.createElement('div');
                    taskEl.className = 'task-item bg-white dark:bg-slate-800 p-3 rounded-lg shadow-sm border border-slate-200 dark:border-slate-700 flex items-center justify-between transition gap-4';
                    taskEl.dataset.id = t.id;
                    taskEl.innerHTML = `
                        <div class="relative flex-shrink-0">
                             <button class="action-menu-btn text-slate-400 dark:text-slate-500 hover:text-slate-600 dark:hover:text-slate-300 p-1.5 rounded-md"><i class="fas fa-ellipsis-v text-xs"></i></button>
                             <div class="action-menu bg-white dark:bg-slate-800 rounded-md shadow-lg border border-slate-200 dark:border-slate-700">
                                 <button class="action-menu-item edit-btn text-slate-700 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700"><i class="fas fa-pencil-alt"></i>Edit</button>
                                 <button class="action-menu-item delete-btn text-slate-700 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700"><i class="fas fa-trash-alt"></i>Delete</button>
                             </div>
                        </div>
                        <div class="flex-1 flex items-baseline gap-2 truncate">
                            <p class="font-semibold text-slate-800 dark:text-slate-200 task-name text-base truncate" title="${t.name}">${t.name}</p>
                            ${mainProjectName ? `<p class="text-xs text-slate-400 dark:text-slate-500 font-medium truncate" title="Project: ${mainProjectName}">[${mainProjectName}]</p>` : ''}
                        </div>
                        <div class="flex items-center gap-4 flex-shrink-0">
                            <div class="flex items-center text-xs text-slate-500 dark:text-slate-400 w-20">
                                <i class="fas fa-flag ${priorityColors[t.priority]} mr-1.5"></i><span>${t.priority}</span>
                            </div>
                            <div class="w-24">
                                <span class="status-badge ${statusColors[t.status]}">${t.status}</span>
                            </div>
                            <div class="countdown w-48 text-right text-slate-800 dark:text-slate-200" data-due-date="${t.dueDate}" data-due-time="${t.dueTime || ''}"></div>
                            <button class="view-task-btn text-xs bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600 text-slate-600 dark:text-slate-300 font-semibold py-1 px-3 rounded-md">View</button>
                        </div>`;
                    taskListEl.appendChild(taskEl);
                });
                updateCountdowns();
            }

            function renderSummaryBar() {
                if (!summaryBarEl) return;

                if (!localState.userId) {
                    summaryBarEl.innerHTML = '';
                    return;
                }

                const totalTasks = localState.tasks.filter(t => t.status !== 'Completed').length;
                const revisionTasks = localState.tasks.filter(t => t.status === 'Needs Revision').length;
                const completedTasksCount = localState.tasks.filter(t => t.status === 'Completed').length;

                summaryBarEl.innerHTML = `
                    <div class="flex items-center justify-between bg-white dark:bg-slate-800 p-3 rounded-lg shadow-sm text-sm border border-slate-200 dark:border-slate-700">
                        <div class="flex items-center gap-6">
                            <div class="flex items-center gap-2">
                                <span class="text-slate-600 dark:text-slate-300">Active Tasks:</span>
                                <span class="bg-indigo-100 text-indigo-700 dark:bg-indigo-900/50 dark:text-indigo-300 font-bold px-2 py-0.5 rounded-full text-xs">${totalTasks}</span>
                            </div>
                            <div class="flex items-center gap-2 text-slate-500 dark:text-slate-400">
                                <span>For Revision:</span>
                                <span class="font-semibold">${revisionTasks}</span>
                            </div>
                        </div>
                         <button id="showCompletedBtn" class="flex items-center gap-2 text-slate-500 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-700 p-1 rounded-md transition-colors">
                            <span>Completed:</span>
                            <span class="font-semibold text-green-600 dark:text-green-400">${completedTasksCount}</span>
                        </button>
                    </div>
                `;

                document.getElementById('showCompletedBtn')?.addEventListener('click', () => {
                    renderCompletedTasks();
                    mainView.style.display = 'none';
                    taskDetailPage.style.display = 'none';
                    completedTasksView.style.display = 'block';
                });
            }

            function renderLoginPrompt() {
                taskListEl.innerHTML = `
                    <div class="text-center py-6 border-t border-slate-200 dark:border-slate-700 mt-4">
                        <p class="text-slate-500 dark:text-slate-400">
                            <a href="#" id="promptSignInLink" class="text-indigo-600 dark:text-indigo-400 font-semibold hover:underline">Sign in</a> to manage your projects and tasks.
                        </p>
                    </div>
                `;
                summaryBarEl.innerHTML = '';
                document.getElementById('promptSignInLink').addEventListener('click', (e) => {
                    e.preventDefault();
                    signInModal.style.display = 'flex';
                });
            }

            function renderCompletedTasks() {
                const completedTaskListEl = document.getElementById('completedTaskList');
                const completedTasks = localState.tasks.filter(t => t.status === 'Completed');

                if (completedTasks.length === 0) {
                    completedTaskListEl.innerHTML = `<p class="text-slate-500 dark:text-slate-400 text-center py-6 text-sm">No completed tasks yet.</p>`;
                    return;
                }

                completedTaskListEl.innerHTML = '';
                completedTasks.forEach(t => {
                    let mainProjectName = 'N/A';
                    for (const p of localState.projects) {
                        if (p.id === t.projectId) { mainProjectName = p.name; break; }
                        const sp = (p.subProjects || []).find(sp => sp.id === t.projectId);
                        if (sp) { mainProjectName = p.name; break; }
                    }

                    const taskEl = document.createElement('div');
                    taskEl.className = 'task-item bg-white dark:bg-slate-800 p-3 rounded-lg shadow-sm border border-slate-200 dark:border-slate-700 flex items-center justify-between transition gap-4';
                    taskEl.dataset.id = t.id;
                    taskEl.innerHTML = `
                        <div class="flex-1 flex items-baseline gap-2 truncate">
                            <i class="fas fa-check-circle text-green-500"></i>
                            <p class="font-semibold text-slate-600 dark:text-slate-400 task-name text-base truncate line-through" title="${t.name}">${t.name}</p>
                            ${mainProjectName ? `<p class="text-xs text-slate-400 dark:text-slate-500 font-medium truncate" title="Project: ${mainProjectName}">[${mainProjectName}]</p>` : ''}
                        </div>
                        <div class="flex items-center gap-4 flex-shrink-0">
                            <button class="view-task-btn text-xs bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600 text-slate-600 dark:text-slate-300 font-semibold py-1 px-3 rounded-md">View</button>
                            <button class="delete-btn text-xs text-red-500 hover:text-red-700 font-semibold py-1 px-3 rounded-md"><i class="fas fa-trash-alt"></i></button>
                        </div>`;
                    completedTaskListEl.appendChild(taskEl);
                });
            }

            function updateProjectDropdown() {
                const select = document.getElementById('taskProject');
                select.innerHTML = '<option value="">Select Project</option>';
                localState.projects.forEach(p => {
                    const mainOption = document.createElement('option');
                    mainOption.value = p.id;
                    mainOption.textContent = p.name;
                    mainOption.style.fontWeight = 'bold';
                    select.appendChild(mainOption);

                    (p.subProjects || []).forEach(sp => {
                        const subOption = document.createElement('option');
                        subOption.value = sp.id;
                        subOption.textContent = `\u00A0\u00A0\u00A0 ${sp.name}`;
                        select.appendChild(subOption);
                    });
                });
            }

            function updateCountdowns() {
                document.querySelectorAll('.countdown').forEach(el => {
                    const dueDate = el.dataset.dueDate;
                    const dueTime = el.dataset.dueTime;
                    if (!dueDate) { el.innerHTML = ''; return; }
                    
                    const dueDateTimeString = `${dueDate}${dueTime ? 'T' + dueTime : 'T23:59:59'}`;
                    const distance = new Date(dueDateTimeString).getTime() - new Date().getTime();

                    if (distance < 0) {
                        const absDistance = Math.abs(distance);
                        const d = Math.floor(absDistance / (1000 * 60 * 60 * 24));
                        const h = Math.floor((absDistance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                        const m = Math.floor((absDistance % (1000 * 60 * 60)) / (1000 * 60));
                        el.innerHTML = `<span class="late text-red-500 dark:text-red-400">${d}d ${h}h ${m}m late</span>`;
                        return;
                    }

                    const d = Math.floor(distance / (1000 * 60 * 60 * 24));
                    const h = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                    const m = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                    const s = Math.floor((distance % (1000 * 60)) / 1000);
                    
                    el.innerHTML = `<div class="countdown-grid">
                            <div class="countdown-item"><span class="countdown-number">${String(d).padStart(2, '0')}</span><span class="countdown-label text-slate-500 dark:text-slate-400">d</span></div>
                            <div class="countdown-item"><span class="countdown-number">${String(h).padStart(2, '0')}</span><span class="countdown-label text-slate-500 dark:text-slate-400">h</span></div>
                            <div class="countdown-item"><span class="countdown-number">${String(m).padStart(2, '0')}</span><span class="countdown-label text-slate-500 dark:text-slate-400">m</span></div>
                            <div class="countdown-item"><span class="countdown-number">${String(s).padStart(2, '0')}</span><span class="countdown-label text-slate-500 dark:text-slate-400">s</span></div>
                        </div>`;
                });
            }

            async function renderAuthUI(user) {
                if (user && !user.isAnonymous) {
                    const profilePath = `/users/${user.uid}`;
                    const profileDoc = await getDoc(doc(db, profilePath));
                    const profileData = profileDoc.exists() ? profileDoc.data() : { username: user.email, name: '', phone: '', photoURL: '' };

                    authContainer.innerHTML = `
                        <div class="flex items-center cursor-pointer" id="profile-section">
                            <img class="h-8 w-8 rounded-full object-cover" src="${profileData.photoURL || `https://placehold.co/100x100/E2E8F0/475569?text=${profileData.username.charAt(0).toUpperCase()}`}" alt="User avatar">
                            <div class="ml-2 overflow-hidden">
                                <p class="text-sm font-semibold text-slate-700 dark:text-slate-300 truncate">${profileData.name || profileData.username}</p>
                                <div class="text-xs">
                                    <a href="#" class="text-slate-500 dark:text-slate-400 hover:text-indigo-600 dark:hover:text-indigo-400" id="settingsBtn">Settings</a>
                                    <span class="mx-1 text-slate-400 dark:text-slate-500"></span>
                                    <a href="#" class="text-slate-500 dark:text-slate-400 hover:text-indigo-600 dark:hover:text-indigo-400" id="signOutBtn">Sign Out</a>
                                </div>
                            </div>
                        </div>`;
                    document.getElementById('signOutBtn').addEventListener('click', () => signOut(auth));
                    document.getElementById('profile-section').addEventListener('click', (e) => {
                        if(e.target.id !== 'signOutBtn') {
                            document.getElementById('profileName').value = profileData.name || '';
                            document.getElementById('profileUsername').value = profileData.username || '';
                            document.getElementById('profileEmail').value = user.email;
                            document.getElementById('profilePhone').value = profileData.phone || '';
                            document.getElementById('profileImagePreview').src = profileData.photoURL || `https://placehold.co/100x100/E2E8F0/475569?text=${profileData.username.charAt(0).toUpperCase()}`;
                            profileSettingsModal.style.display = 'flex';
                        }
                    });
                    signInModal.style.display = 'none';
                    document.body.classList.remove('overflow-hidden');
                } else {
                    authContainer.innerHTML = `<button id="showSignInBtn" class="w-full bg-indigo-600 text-white font-bold py-1.5 px-3 rounded-md hover:bg-indigo-700 text-sm">Sign In / Register</button>`;
                    document.getElementById('showSignInBtn').addEventListener('click', () => {
                        signInModal.style.display = 'flex';
                    });
                }
                setGreeting();
            }

            function renderSubtasksAndRevisions(task) {
                const subtaskList = document.getElementById('subtaskList');
                const revisionList = document.getElementById('revisionList');
                
                subtaskList.innerHTML = '';
                if (task.subtasks && task.subtasks.length > 0) {
                    task.subtasks.forEach(st => {
                        const item = document.createElement('label');
                        item.className = 'subtask-item flex items-center gap-3 p-2 rounded-md hover:bg-slate-100 dark:hover:bg-slate-700 cursor-pointer';
                        item.dataset.subtaskId = st.id;
                        item.innerHTML = `
                            <input type="checkbox" class="h-4 w-4 rounded border-gray-300 dark:border-slate-600 text-indigo-600 bg-gray-100 dark:bg-slate-900 focus:ring-indigo-500" ${st.completed ? 'checked' : ''}>
                            <span class="text-sm text-slate-700 dark:text-slate-300 ${st.completed ? 'line-through text-slate-400 dark:text-slate-500' : ''}">${st.text}</span>
                        `;
                        subtaskList.appendChild(item);
                    });
                } else {
                    subtaskList.innerHTML = '<p class="text-xs text-slate-400 dark:text-slate-500 text-center py-2">No sub-tasks yet.</p>';
                }

                revisionList.innerHTML = '';
                if (task.revisions && task.revisions.length > 0) {
                    task.revisions.forEach(rev => {
                        const item = document.createElement('div');
                        item.className = 'p-3 bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-800/50 rounded-md';
                        const revDate = rev.date.toDate();
                        const dateString = revDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                        const timeString = revDate.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });

                        item.innerHTML = `
                            <p class="text-sm text-slate-700 dark:text-amber-200">${rev.note}</p>
                            <p class="text-xs text-slate-500 dark:text-amber-400/60 mt-1">Revision #${rev.number} - ${dateString} at ${timeString}</p>
                        `;
                        revisionList.appendChild(item);
                    });
                } else {
                    revisionList.innerHTML = '<p class="text-xs text-slate-400 dark:text-slate-500 text-center py-2">No revision history.</p>';
                }
            }

            // --- EVENT HANDLERS ---
            document.body.addEventListener('click', e => {
                if (!e.target.closest('.action-menu-btn')) {
                    document.querySelectorAll('.action-menu').forEach(menu => menu.style.display = 'none');
                    document.querySelectorAll('.submenu').forEach(sm => sm.classList.remove('overflow-visible'));
                }
            });

            sidebarNav.addEventListener('click', e => {
                const link = e.target.closest('.sidebar-link');
                if (link) {
                    e.preventDefault();
                    document.querySelectorAll('.sidebar-link').forEach(l => l.classList.remove('active'));
                    link.classList.add('active');
                    const id = link.dataset.id, title = link.dataset.title, parent = link.closest('.sub-project-item');
                    if (id === 'home' || id === 'upcoming') localState.activeView = { type: 'home', id, title };
                    else if (parent) localState.activeView = { type: 'sub-project', id, title };
                    else localState.activeView = { type: 'project', id, title };
                    renderTasks();
                }
            });

            projectListEl.addEventListener('click', async e => {
                const target = e.target;
                const projectItem = target.closest('.project-item');
                const subProjectItem = target.closest('.sub-project-item');

                if (target.closest('.action-menu-btn')) {
                    e.stopPropagation();
                    const menu = target.closest('.relative').querySelector('.action-menu');
                    const isVisible = menu.style.display === 'block';
                    document.querySelectorAll('.action-menu').forEach(m => m.style.display = 'none');
                    document.querySelectorAll('.submenu').forEach(sm => sm.classList.remove('overflow-visible'));
                    if (!isVisible) {
                        menu.style.display = 'block';
                        const parentSubmenu = target.closest('.submenu');
                        if (parentSubmenu) parentSubmenu.classList.add('overflow-visible');
                    }
                } else if (target.closest('.expand-btn')) {
                    const submenu = projectItem.querySelector('.submenu');
                    submenu.style.maxHeight = submenu.style.maxHeight ? null : submenu.scrollHeight + "px";
                    target.closest('.expand-btn').classList.toggle('rotate-180');
                } else if (target.closest('.edit-btn')) {
                    if (subProjectItem) openSubProjectModal('edit', subProjectItem);
                    else if (projectItem) openProjectModal('edit', projectItem);
                } else if (target.closest('.delete-btn')) {
                    if (subProjectItem) {
                        const parentId = subProjectItem.dataset.parentId;
                        const subId = subProjectItem.dataset.id;
                        const parentDoc = localState.projects.find(p => p.id === parentId);
                        const updatedSubProjects = parentDoc.subProjects.filter(sp => sp.id !== subId);
                        await updateDoc(doc(localState.projectsCollectionRef, parentId), { subProjects: updatedSubProjects });
                    } else if (projectItem) {
                        await deleteDoc(doc(localState.projectsCollectionRef, projectItem.dataset.id));
                    }
                } else if (target.closest('.add-sub-project-btn')) {
                    openSubProjectModal('add', projectItem);
                }
            });
            
            function handleTaskItemClick(e) {
                const taskItem = e.target.closest('.task-item');
                if (!taskItem) return;

                if (e.target.closest('.action-menu-btn')) {
                    e.stopPropagation();
                    const menu = e.target.closest('.relative').querySelector('.action-menu');
                    const isVisible = menu.style.display === 'block';
                    document.querySelectorAll('.action-menu').forEach(m => m.style.display = 'none');
                    menu.style.display = isVisible ? 'none' : 'block';
                } else if (e.target.closest('.edit-btn')) {
                     const task = localState.tasks.find(t => t.id === taskItem.dataset.id);
                     if(task) openTaskModal('edit', taskItem);
                } else if (e.target.closest('.delete-btn')) {
                    deleteDoc(doc(localState.tasksCollectionRef, taskItem.dataset.id));
                } else if (e.target.closest('.view-task-btn')) {
                    const taskId = taskItem.dataset.id;
                    const task = localState.tasks.find(t => t.id === taskId);
                    if (task) {
                        openTaskDetailModal(task);
                    }
                }
            }

            taskListEl.addEventListener('click', handleTaskItemClick);
            document.getElementById('completedTaskList').addEventListener('click', handleTaskItemClick);

            document.getElementById('addProjectBtn').addEventListener('click', () => openProjectModal('add'));
            document.getElementById('addTaskBtn').addEventListener('click', () => openTaskModal('add'));
            
            // --- MODAL & FORM LOGIC ---
            function openProjectModal(mode, el = null) {
                projectForm.reset();
                if (mode === 'edit') {
                    const project = localState.projects.find(p => p.id === el.dataset.id);
                    localState.editing = { type: 'project', id: project.id };
                    document.getElementById('projectModalTitle').textContent = 'Edit Project';
                    document.getElementById('projectName').value = project.name;
                    document.getElementById('projectSubmitBtn').textContent = 'Save Changes';
                } else {
                    localState.editing = { type: 'project', id: null };
                    document.getElementById('projectModalTitle').textContent = 'Add a New Project';
                    document.getElementById('projectSubmitBtn').textContent = 'Create';
                }
                projectModal.style.display = 'flex';
            }

            function openSubProjectModal(mode, parentEl) {
                subProjectForm.reset();
                if (mode === 'edit') {
                    const parentId = parentEl.dataset.parentId;
                    const subProjectId = parentEl.dataset.id;
                    const parentProject = localState.projects.find(p => p.id === parentId);
                    if (!parentProject) return console.error("Parent project not found");
                    const subProject = parentProject.subProjects.find(sp => sp.id === subProjectId);
                    if (!subProject) return console.error("Sub-project not found");

                    localState.editing = { type: 'sub-project', id: subProjectId, parentId: parentId };
                    document.getElementById('subProjectModalTitle').textContent = 'Edit Item';
                    document.getElementById('subProjectName').value = subProject.name;
                    document.getElementById('subProjectSubmitBtn').textContent = 'Save Changes';
                } else {
                    localState.editing = { type: 'sub-project', id: null, parentId: parentEl.dataset.id };
                    document.getElementById('subProjectModalTitle').textContent = 'Add New Item';
                    document.getElementById('subProjectSubmitBtn').textContent = 'Create';
                }
                subProjectModal.style.display = 'flex';
            }

            function openTaskModal(mode, el = null) {
                taskFormEl.reset();
                document.getElementById('taskName').classList.remove('border-red-500');
                document.getElementById('taskProject').classList.remove('border-red-500');
                updateProjectDropdown();
                if (mode === 'edit') {
                    const task = localState.tasks.find(t => t.id === el.dataset.id);
                    if (!task) return console.error("Task not found for editing");
                    
                    localState.editing = { type: 'task', id: task.id };
                    document.getElementById('taskModalTitle').textContent = 'Edit Task';
                    document.getElementById('taskName').value = task.name;
                    document.getElementById('taskDescription').value = task.description || '';
                    document.getElementById('taskDueDate').value = task.dueDate;
                    document.getElementById('taskDueTime').value = task.dueTime || '';
                    document.getElementById('taskProject').value = task.projectId;
                    document.getElementById('taskPriority').value = task.priority;
                    document.getElementById('taskStatus').value = task.status;
                    document.getElementById('taskNotes').value = task.notes || '';
                    document.getElementById('taskSubmitBtn').textContent = 'Save Changes';
                } else {
                    localState.editing = { type: 'task', id: null };
                    document.getElementById('taskModalTitle').textContent = 'Add a New Task';
                    document.getElementById('taskSubmitBtn').textContent = 'Add Task';
                    if (localState.activeView.type === 'sub-project') {
                        document.getElementById('taskProject').value = localState.activeView.id;
                    } else if (localState.activeView.type === 'project') {
                        document.getElementById('taskProject').value = localState.activeView.id;
                    }
                }
                taskModal.style.display = 'flex';
            }

            function openTaskDetailModal(task) {
                document.getElementById('detailTaskName').textContent = task.name || 'No Title';
                document.getElementById('detailTaskDescription').textContent = task.description || 'No description provided.';
                
                let dueDateText = 'Not set';
                if (task.dueDate) {
                    dueDateText = new Date(task.dueDate + 'T00:00:00').toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
                    if (task.dueTime) {
                        dueDateText += ' at ' + new Date('1970-01-01T' + task.dueTime).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
                    }
                }
                document.getElementById('detailTaskDueDate').textContent = dueDateText;

                let projectName = 'N/A';
                const mainProject = localState.projects.find(p => p.id === task.projectId);

                if (mainProject) {
                    projectName = mainProject.name;
                } else {
                     for (const p of localState.projects) {
                        const sp = (p.subProjects || []).find(sp => sp.id === task.projectId);
                        if (sp) {
                            projectName = `${p.name} / ${sp.name}`;
                            break;
                        }
                    }
                }
               
                document.getElementById('detailTaskProject').textContent = projectName;
                document.getElementById('detailTaskStatus').textContent = task.status || 'N/A';
                document.getElementById('detailTaskNotes').textContent = task.notes || 'No notes added.';
                taskDetailPage.dataset.editingId = task.id;
                
                renderSubtasksAndRevisions(task);

                mainView.style.display = 'none';
                completedTasksView.style.display = 'none';
                taskDetailPage.style.display = 'block';
            }
            
            projectForm.addEventListener('submit', async e => {
                e.preventDefault();
                const name = document.getElementById('projectName').value.trim();
                if (!name) return;
                if (localState.editing.id) {
                    const projectRef = doc(localState.projectsCollectionRef, localState.editing.id);
                    await updateDoc(projectRef, { name });
                } else {
                    await addDoc(localState.projectsCollectionRef, { name, subProjects: [] });
                }
                projectModal.style.display = 'none';
            });

            subProjectForm.addEventListener('submit', async e => {
                e.preventDefault();
                const name = document.getElementById('subProjectName').value.trim();
                if (!name) return;
                const parentProjectRef = doc(localState.projectsCollectionRef, localState.editing.parentId);
                const parentProject = localState.projects.find(p => p.id === localState.editing.parentId);
                let updatedSubProjects;
                if (localState.editing.id) {
                    updatedSubProjects = parentProject.subProjects.map(sp => sp.id === localState.editing.id ? { ...sp, name } : sp);
                } else {
                    updatedSubProjects = [...(parentProject.subProjects || []), { id: `sub-${Date.now()}`, name }];
                }
                await updateDoc(parentProjectRef, { subProjects: updatedSubProjects });
                subProjectModal.style.display = 'none';
            });

            taskFormEl.addEventListener('submit', async e => {
                e.preventDefault();
                const taskNameInput = document.getElementById('taskName');
                const taskProjectSelect = document.getElementById('taskProject');
                
                taskNameInput.classList.remove('border-red-500');
                taskProjectSelect.classList.remove('border-red-500');

                const formData = {
                    name: taskNameInput.value.trim(),
                    description: document.getElementById('taskDescription').value.trim(),
                    dueDate: document.getElementById('taskDueDate').value,
                    dueTime: document.getElementById('taskDueTime').value,
                    projectId: taskProjectSelect.value,
                    priority: document.getElementById('taskPriority').value,
                    status: document.getElementById('taskStatus').value,
                    notes: document.getElementById('taskNotes').value.trim(),
                    revisions: [],
                    subtasks: []
                };

                let formIsValid = true;
                if (!formData.name) {
                    taskNameInput.classList.add('border-red-500', 'focus:border-red-500', 'focus:ring-red-500');
                    formIsValid = false;
                }
                if (!formData.projectId) {
                    taskProjectSelect.classList.add('border-red-500', 'focus:border-red-500', 'focus:ring-red-500');
                    formIsValid = false;
                }

                if (!formIsValid) { return; }

                if (localState.editing.id) {
                    delete formData.revisions;
                    delete formData.subtasks;
                    const taskRef = doc(localState.tasksCollectionRef, localState.editing.id);
                    await updateDoc(taskRef, formData);
                } else {
                    await addDoc(localState.tasksCollectionRef, formData);
                }
                taskModal.style.display = 'none';
            });

            document.getElementById('cancelProjectBtn').addEventListener('click', () => projectModal.style.display = 'none');
            document.getElementById('cancelSubProjectBtn').addEventListener('click', () => subProjectModal.style.display = 'none');
            document.getElementById('cancelTaskBtn').addEventListener('click', () => taskModal.style.display = 'none');
            
            // --- AUTH & FIRESTORE LISTENERS ---
            function setupFirestoreListeners(userId) {
                localState.userId = userId;
                
                const projectsCollectionRef = collection(db, 'users', userId, 'projects');
                const tasksCollectionRef = collection(db, 'users', userId, 'tasks');
                localState.projectsCollectionRef = projectsCollectionRef;
                localState.tasksCollectionRef = tasksCollectionRef;

                getDocs(projectsCollectionRef).then(initialCheck => {
                    if (initialCheck.empty) {
                        console.log("No projects found for this user. Seeding initial data.");
                        const batch = writeBatch(db);
                        const initialProjects = [
                            { id: 'proj-1', name: 'Personal', subProjects: [{id: 'sub-1', name: 'Groceries'}, {id: 'sub-2', name: 'Fitness Plan'}] },
                            { id: 'proj-2', name: 'My Company', subProjects: [{id: 'sub-3', name: 'Q3 Report'}, {id: 'sub-4', name: 'Website Launch'}] }
                        ];
                        initialProjects.forEach(p => {
                            const docRef = doc(projectsCollectionRef, p.id);
                            batch.set(docRef, p);
                        });
                        batch.commit();
                    }
                }).catch(error => { console.error("Error checking for initial documents:", error); });

                localState.projectsUnsubscribe = onSnapshot(projectsCollectionRef, (snapshot) => {
                    localState.projects = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderAll();
                }, (error) => { console.error("Error in projects snapshot listener:", error); });

                localState.tasksUnsubscribe = onSnapshot(tasksCollectionRef, (snapshot) => {
                    localState.tasks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderTasks();
                    renderSummaryBar();
                }, (error) => { console.error("Error in tasks snapshot listener:", error); });
            }

            function cleanupFirestoreListeners() {
                if (localState.projectsUnsubscribe) localState.projectsUnsubscribe();
                if (localState.tasksUnsubscribe) localState.tasksUnsubscribe();
                localState.userId = null;
                localState.projects = [];
                localState.tasks = [];
                renderAll();
                renderSummaryBar();
            }

            authToggleLink.addEventListener('click', (e) => {
                e.preventDefault();
                localState.isRegisterMode = !localState.isRegisterMode;
                const title = document.getElementById('authModalTitle');
                const submitBtn = document.getElementById('authSubmitBtn');
                const toggleText = document.getElementById('authToggleText');
                const registerFields = document.getElementById('registerFields');
                const policyField = document.getElementById('policyField');
                const authOptions = document.getElementById('authOptions');
                document.getElementById('authError').textContent = '';

                if (localState.isRegisterMode) {
                    title.textContent = 'Create an Account';
                    submitBtn.textContent = 'Register';
                    toggleText.textContent = 'Already have an account?';
                    authToggleLink.textContent = 'Sign In';
                    registerFields.classList.remove('hidden');
                    policyField.classList.remove('hidden');
                    authOptions.classList.add('hidden');
                } else {
                    title.textContent = 'Welcome Back';
                    submitBtn.textContent = 'Sign In';
                    toggleText.textContent = "Don't have an account?";
                    authToggleLink.textContent = 'Register';
                    registerFields.classList.add('hidden');
                    policyField.classList.add('hidden');
                    authOptions.classList.remove('hidden');
                }
            });

            authForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('authEmail').value;
                const password = document.getElementById('authPassword').value;
                const errorDiv = document.getElementById('authError');
                const keepLoggedIn = document.getElementById('authPersistence').checked;
                errorDiv.textContent = '';

                const persistence = keepLoggedIn ? browserLocalPersistence : browserSessionPersistence;

                try {
                    await setPersistence(auth, persistence);

                    if (localState.isRegisterMode) {
                        const username = document.getElementById('authUsername').value;
                        const policyChecked = document.getElementById('authPolicy').checked;

                        if (!username) { errorDiv.textContent = 'Username is required.'; return; }
                        if (!policyChecked) { errorDiv.textContent = 'You must agree to the terms and policy.'; return; }

                        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                        const user = userCredential.user;
                        const profilePath = `/users/${user.uid}`;
                        await setDoc(doc(db, profilePath), { username, email, name: username, phone: '', photoURL: '' });

                    } else {
                        await signInWithEmailAndPassword(auth, email, password);
                    }
                } catch (error) {
                    errorDiv.textContent = error.message;
                }
            });
            
            document.getElementById('forgotPasswordLink').addEventListener('click', (e) => {
                e.preventDefault();
                const email = prompt("Please enter your email address to reset your password:");
                if (email) {
                    sendPasswordResetEmail(auth, email)
                        .then(() => showToast("Password reset email sent!"))
                        .catch((error) => { document.getElementById('authError').textContent = error.message; });
                }
            });

            document.querySelectorAll('.social-login-btn').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const providerName = btn.dataset.provider;
                    const errorDiv = document.getElementById('authError');
                    errorDiv.textContent = '';

                    if (providerName === 'google') {
                        const provider = new GoogleAuthProvider();
                        try {
                            const result = await signInWithPopup(auth, provider);
                            const user = result.user;
                            const profilePath = `/users/${user.uid}`;
                            const profileDoc = await getDoc(doc(db, profilePath));
                            if (!profileDoc.exists()) {
                                await setDoc(doc(db, profilePath), { 
                                    username: user.displayName || user.email, 
                                    email: user.email, 
                                    name: user.displayName || '', 
                                    phone: user.phoneNumber || '', 
                                    photoURL: user.photoURL || '' 
                                });
                            }
                        } catch (error) {
                            errorDiv.textContent = error.message;
                        }
                    } else if (providerName === 'apple') {
                        showToast("Apple Sign-In is coming soon!");
                    } else if (providerName === 'github') {
                        showToast("GitHub Sign-In is coming soon!");
                    }
                });
            });

             document.querySelectorAll('.ai-feature-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const tool = e.currentTarget.dataset.tool;
                    if (tool === 'paraphraser') {
                        aiHubModal.style.display = 'flex';
                    } else {
                        showToast("This AI feature is coming soon!");
                    }
                });
            });

            document.getElementById('closeAiHubBtn').addEventListener('click', () => {
                aiHubModal.style.display = 'none';
            });

            document.getElementById('ai-tools-nav').addEventListener('click', (e) => {
                const button = e.target.closest('.ai-tool-nav-btn');
                if (!button) return;

                document.querySelectorAll('.ai-tool-nav-btn').forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');

                document.querySelectorAll('.ai-tool-content').forEach(content => content.classList.add('hidden'));
                const toolName = button.dataset.tool;
                document.getElementById(`${toolName}-tool`).classList.remove('hidden');
            });
            
            // Paraphraser Logic
            const paraphraserInput = document.getElementById('paraphraserInput');
            const paraphraserOutput = document.getElementById('paraphraserOutput');
            const paraphraseBtn = document.getElementById('paraphraseBtn');
            const paraphraseBtnText = document.getElementById('paraphraseBtnText');
            const paraphraseBtnIcon = document.getElementById('paraphraseBtnIcon');
            const inputWordCountEl = document.getElementById('inputWordCount');
            const outputWordCountEl = document.getElementById('outputWordCount');
            const paraphraserModeContainer = document.getElementById('paraphraserModeContainer');
            
            function updateWordCount(textarea, countEl) {
                const text = textarea.value;
                const words = text.trim().split(/\s+/).filter(Boolean).length;
                const chars = text.length;
                countEl.textContent = `${words} words / ${chars} characters`;
            }

            paraphraserInput.addEventListener('input', () => {
                updateWordCount(paraphraserInput, inputWordCountEl);
                paraphraseBtnText.textContent = 'Paraphrase';
                paraphraseBtnIcon.classList.remove('fa-sync-alt');
                paraphraseBtnIcon.classList.add('fa-arrow-right');
            });
            paraphraserOutput.addEventListener('input', () => updateWordCount(paraphraserOutput, outputWordCountEl));

            paraphraseBtn.addEventListener('click', async () => {
                const textToParaphrase = paraphraserInput.value.trim();
                if (!textToParaphrase) return;

                const activeMode = paraphraserModeContainer.querySelector('.active').dataset.mode;
                
                let prompt = `You are a helpful writing assistant. Paraphrase the following text in a ${activeMode.toLowerCase()} style. Provide only the single best result. Text to paraphrase: "${textToParaphrase}"`;

                paraphraseBtnText.textContent = 'Paraphrasing...';
                paraphraseBtnIcon.classList.remove('fa-arrow-right', 'fa-sync-alt');
                paraphraseBtnIcon.classList.add('fa-spinner', 'fa-spin');
                paraphraseBtn.disabled = true;
                paraphraserOutput.value = '';

                try {
                    let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
                    const payload = { 
                        contents: chatHistory
                    };
                    const apiKey = ""; 
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                    
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        throw new Error(`API request failed with status ${response.status}`);
                    }

                    const result = await response.json();
                    
                    if (result.candidates && result.candidates.length > 0 &&
                        result.candidates[0].content && result.candidates[0].content.parts &&
                        result.candidates[0].content.parts.length > 0) {
                        
                        const paraphrasedText = result.candidates[0].content.parts[0].text;
                        
                        paraphraserOutput.value = paraphrasedText || "No result found.";
                        updateWordCount(paraphraserOutput, outputWordCountEl);
                        
                        paraphraseBtnText.textContent = 'Regenerate';
                        paraphraseBtnIcon.classList.remove('fa-spinner', 'fa-spin');
                        paraphraseBtnIcon.classList.add('fa-sync-alt');

                    } else {
                        throw new Error("Invalid response structure from API.");
                    }

                } catch (error) {
                    console.error("Error calling Gemini API:", error);
                    paraphraserOutput.value = "Sorry, an error occurred. Please try again.";
                    showToast("Error during paraphrasing.");
                    paraphraseBtnText.textContent = 'Paraphrase';
                    paraphraseBtnIcon.classList.remove('fa-spinner', 'fa-spin');
                    paraphraseBtnIcon.classList.add('fa-arrow-right');
                } finally {
                    paraphraseBtn.disabled = false;
                }
            });

            document.getElementById('copyOutputBtn').addEventListener('click', () => {
                paraphraserOutput.select();
                document.execCommand('copy');
                showToast("Copied to clipboard!");
            });

            paraphraserModeContainer.addEventListener('click', (e) => {
                if(e.target.classList.contains('paraphraser-mode')) {
                    paraphraserModeContainer.querySelectorAll('.paraphraser-mode').forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');
                }
            });


            function setGreeting() {
                const hour = new Date().getHours();
                let greeting = "Good Morning";
                if (hour >= 18) { greeting = "Good Evening"; } 
                else if (hour >= 12) { greeting = "Good Afternoon"; }
                mainHeader.textContent = greeting;
            }

            document.getElementById('profileImageUpload').addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => { document.getElementById('profileImagePreview').src = event.target.result; }
                    reader.readAsDataURL(file);
                }
            });

            profileSettingsForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const user = auth.currentUser;
                if (!user) return;
                
                const submitBtn = profileSettingsForm.querySelector('button[type="submit"]');
                submitBtn.disabled = true;
                submitBtn.textContent = 'Saving...';

                try {
                    const name = document.getElementById('profileName').value;
                    const username = document.getElementById('profileUsername').value;
                    const phone = document.getElementById('profilePhone').value;
                    const file = document.getElementById('profileImageUpload').files[0];
                    
                    const profilePath = `/users/${user.uid}`;
                    const profileRef = doc(db, profilePath);

                    const dataToUpdate = { name, username, phone };

                    if (file) {
                        const storageRef = ref(storage, `profile-pictures/${user.uid}`);
                        await uploadBytes(storageRef, file);
                        dataToUpdate.photoURL = await getDownloadURL(storageRef);
                    }
                    await setDoc(profileRef, dataToUpdate, { merge: true });
                    profileSettingsModal.style.display = 'none';
                    renderAuthUI(user);
                } catch (error) {
                    console.error("Error updating profile:", error);
                    showToast("Could not save profile. Please try again.");
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Save Changes';
                }
            });

            cancelProfileSettingsBtn.addEventListener('click', () => profileSettingsModal.style.display = 'none');
            
            document.getElementById('backToTasksBtn').addEventListener('click', () => {
                mainView.style.display = 'flex';
                taskDetailPage.style.display = 'none';
                completedTasksView.style.display = 'none';
            });
            
            document.getElementById('backToMainFromCompleted').addEventListener('click', () => {
                completedTasksView.style.display = 'none';
                mainView.style.display = 'flex';
            });

            document.getElementById('editDetailBtn').addEventListener('click', () => {
                const taskId = taskDetailPage.dataset.editingId;
                if (!taskId) return;
                const task = localState.tasks.find(t => t.id === taskId);
                if (task) { openTaskModal('edit', { dataset: { id: taskId } }); }
            });

            signInModal.addEventListener('click', (e) => {
                if (e.target === signInModal) {
                    signInModal.style.display = 'none';
                }
            });

            document.getElementById('requestRevisionBtn').addEventListener('click', () => revisionModal.style.display = 'flex');
            cancelRevisionBtn.addEventListener('click', () => revisionModal.style.display = 'none');

            revisionForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const taskId = taskDetailPage.dataset.editingId;
                const note = document.getElementById('revisionNote').value;
                if (!taskId || !note) return;

                const taskRef = doc(localState.tasksCollectionRef, taskId);
                const task = localState.tasks.find(t => t.id === taskId);
                const revisionNumber = (task.revisions || []).length + 1;

                await updateDoc(taskRef, {
                    status: 'Needs Revision',
                    revisions: arrayUnion({ note, number: revisionNumber, date: Timestamp.now() })
                });
                revisionModal.style.display = 'none';
                revisionForm.reset();
            });

            document.getElementById('markDeliveredBtn').addEventListener('click', async () => {
                const taskId = taskDetailPage.dataset.editingId;
                if(!taskId) return;
                await updateDoc(doc(localState.tasksCollectionRef, taskId), { status: 'Delivered' });
            });

            document.getElementById('markCompletedBtn').addEventListener('click', async () => {
                const taskId = taskDetailPage.dataset.editingId;
                if(!taskId) return;
                await updateDoc(doc(localState.tasksCollectionRef, taskId), { status: 'Completed' });
            });

            document.getElementById('subtaskForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const taskId = taskDetailPage.dataset.editingId;
                const subtaskInput = document.getElementById('subtaskInput');
                const text = subtaskInput.value.trim();
                if (!taskId || !text) return;

                const taskRef = doc(localState.tasksCollectionRef, taskId);
                await updateDoc(taskRef, {
                    subtasks: arrayUnion({ id: `subtask-${Date.now()}`, text, completed: false })
                });
                subtaskInput.value = '';
            });

            taskDetailPage.addEventListener('change', async (e) => {
                if (e.target.matches('.subtask-item input[type="checkbox"]')) {
                    const taskId = taskDetailPage.dataset.editingId;
                    const subtaskId = e.target.closest('.subtask-item').dataset.subtaskId;
                    const isChecked = e.target.checked;

                    const taskRef = doc(localState.tasksCollectionRef, taskId);
                    const task = localState.tasks.find(t => t.id === taskId);
                    
                    const updatedSubtasks = task.subtasks.map(st => st.id === subtaskId ? { ...st, completed: isChecked } : st);
                    await updateDoc(taskRef, { subtasks: updatedSubtasks });
                }
            });

            // --- LIVE MEETING API INTEGRATION ---
            const initializeMeetingFallback = () => {
                liveMeetingBtn.addEventListener('click', () => {
                    showToast("Live Meeting feature is currently unavailable.");
                });
            };
            
            // 1. Create a new <script> tag to load your hosted API file.
            const meetingScript = document.createElement('script');
            meetingScript.type = 'module';
            // 2. IMPORTANT: The URL has been updated with your live hosting link.
            meetingScript.src = 'https://gowafir-taskflow.web.app/meeting-hub.js';
            document.body.appendChild(meetingScript);

            // 3. This runs after the meeting script has loaded successfully.
            meetingScript.onload = () => {
                try {
                    // 4. Initialize the Meeting Hub.
                    // Assumes the loaded script provides a global `LiveMeeting` object.
                    // The `firebaseConfig` variable is already defined at the top of this script.
                    LiveMeeting.init(firebaseConfig);
                    
                    // 5. Tell the button what to do when clicked.
                    liveMeetingBtn.addEventListener('click', () => {
                        LiveMeeting.open();
                    });
                } catch (error) {
                    console.error("Error initializing Live Meeting API:", error);
                    initializeMeetingFallback();
                }
            };
            
            // 6. If the script itself can't be loaded (e.g., 404 error), set up a fallback.
            meetingScript.onerror = () => {
                console.error("Failed to load the meeting hub script from the specified URL.");
                initializeMeetingFallback();
            };


            // --- INITIALIZATION ---
            const currentTheme = document.documentElement.classList.contains('dark') ? 'dark' : 'light';
            updateThemeIcon(currentTheme);
            
            setGreeting();
            document.getElementById('currentDate').textContent = new Date().toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });
            setInterval(updateCountdowns, 1000);
            
            document.querySelector('.sidebar-link[data-id="home"]').classList.add('active');

            onAuthStateChanged(auth, async (user) => {
                await renderAuthUI(user);
                if (user && !user.isAnonymous) {
                    setupFirestoreListeners(user.uid);
                } else {
                    cleanupFirestoreListeners();
                    renderLoginPrompt();
                }
                loadingOverlay.style.opacity = '0';
                setTimeout(() => loadingOverlay.style.display = 'none', 300);
            });
        });

    </script>
</body>
</html>
